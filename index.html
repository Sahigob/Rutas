<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rutas Comerciales PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
    #map { flex:1 }
    #panel { width:350px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
    button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
    button:hover { background:#0284c7 }
    .client { padding:8px; border-bottom:1px solid #ddd }
    .deleteBtn{background:#ef4444;margin-top:6px}
    .deleteBtn:hover{background:#dc2626}
    input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
    small { color:#555 }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Login</h3>
    <input id="email" placeholder="Correo" />
    <input id="password" type="password" placeholder="ContraseÃ±a" />
    <button id="btnLogin">ðŸ”‘ Iniciar sesiÃ³n</button>
    <hr>

    <h3>Clientes</h3>
    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="DirecciÃ³n manual (opcional)" />
    <textarea id="notes" placeholder="Notas"></textarea>
    <select id="day">
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="MiÃ©rcoles">MiÃ©rcoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
    </select>
    <input id="lat" placeholder="Latitud (opcional)" />
    <input id="lng" placeholder="Longitud (opcional)" />

    <button id="btnAddClient">âž• Guardar cliente</button>
    <button id="btnRoute">ðŸ§­ Calcular mejor ruta</button>
    <button id="btnGoogleMaps">ðŸ—º Abrir en Google Maps</button>
    <button id="btnWaze">ðŸš— Abrir en Waze</button>
    <button id="btnExport">ðŸ’¾ Exportar clientes</button>
    <button id="btnImport">ðŸ“‚ Importar clientes</button>
    <button id="btnClearRoute">ðŸ§¹ Borrar ruta y marcadores rojos</button>

    <h3>Punto de salida del dÃ­a</h3>
    <input id="startPoint" placeholder="DirecciÃ³n del punto de inicio (opcional)" />

    <h3>Filtrar por dÃ­a</h3>
    <select id="filterDay">
      <option value="Todos">Todos</option>
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="MiÃ©rcoles">MiÃ©rcoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
    </select>

    <h3>EstadÃ­sticas</h3>
    <div id="stats"></div>

    <h3>Listado</h3>
    <div id="clientList"></div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

// Firebase config y setup (sin cambios)
const firebaseConfig = { /* igual que antes */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db, "clientes");

let clients = [], markers = [], redMarkers = [], routeLine, lastRouteCoords = [];
let map = L.map('map').setView([40.4168, -3.7038], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// LOGIN (igual que antes)
window.login = async function(){ /* ... */ };

// AGREGAR CLIENTE (cambia GPS solo si no hay direcciÃ³n ni coords manuales)
window.addClient = async function(){
  const name = document.getElementById('name').value;
  const address = document.getElementById('address').value;
  const notes = document.getElementById('notes').value;
  const day = document.getElementById('day').value;
  const latInput = document.getElementById('lat').value;
  const lngInput = document.getElementById('lng').value;
  if(!name) return alert('Pon nombre del cliente');

  let lat,lng;
  if(latInput && lngInput){
    lat = parseFloat(latInput);
    lng = parseFloat(lngInput);
  } else if(address){
    const coords = await geocode(address);
    if(!coords) return alert('No se encontrÃ³ direcciÃ³n');
    lat = coords.lat;
    lng = coords.lng;
  } else {
    try {
      const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
      lat = pos.coords.latitude;
      lng = pos.coords.longitude;
    } catch(err){
      return alert('No se pudo obtener tu ubicaciÃ³n');
    }
  }

  await addDoc(coleccionClientes, {name,address,lat,lng,notes,day,visits:0});
  cargarClientesDesdeFirestore();
};

// CALCULAR RUTA con punto de salida opcional
window.calculateRoute = async function(){
  let selected=[];
  clients.forEach((c,i)=>{ if(document.getElementById('c'+i)?.checked) selected.push(c); });
  if(selected.length<1) return alert('Selecciona clientes');

  let originAddress = document.getElementById('startPoint').value;
  let originCoords;
  if(originAddress){
    const coords = await geocode(originAddress);
    if(!coords) return alert('No se pudo geocodificar punto de inicio');
    originCoords = [coords.lng, coords.lat];
  } else {
    try {
      const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
      originCoords = [pos.coords.longitude, pos.coords.latitude];
    } catch(err){
      return alert('No se pudo obtener ubicaciÃ³n para inicio de ruta');
    }
  }

  let coords=[[...originCoords],...selected.map(c=>[c.lng,c.lat])];
  lastRouteCoords = coords;

  let coordString=coords.map(c=>c.join(',')).join(';');
  let url=`https://router.project-osrm.org/trip/v1/driving/${coordString}?source=first&roundtrip=false&overview=full&geometries=geojson`;
  let res=await fetch(url); let data=await res.json();
  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.geoJSON(data.trips[0].geometry).addTo(map);
  map.fitBounds(routeLine.getBounds());

  redMarkers.forEach(m => map.removeLayer(m));
  redMarkers = [];
  selected.forEach(c=>{
    let mRed = L.circleMarker([c.lat,c.lng], {radius:8, color:'red', fillColor:'red', fillOpacity:0.6}).addTo(map);
    redMarkers.push(mRed);
  });
  selected.forEach(c=>c.visits=(c.visits||0)+1);
  cargarClientesDesdeFirestore();
};

// Resto del cÃ³digo (Google Maps, Waze, export/import, render, geocode, listeners) permanece igual
</script>
</body>
</html>
