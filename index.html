<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    :root { --primary: #0ea5e9; --success: #22c55e; --danger: #ef4444; --gray: #64748b; --bg: #f8fafc; }
    body { margin:0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display:flex; height:100vh; background: var(--bg); color: #1e293b; }

    #map { flex:1; height: 100%; }
    #panel { width:400px; display:flex; flex-direction: column; background:white; border-left:1px solid #e2e8f0; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }

    .tabs { display: flex; background: #f1f5f9; padding: 5px; gap: 5px; }
    .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: transparent; color: var(--gray); transition: 0.2s; }
    .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .tab-content { display: none; padding: 16px; overflow-y: auto; flex: 1; }
    .tab-content.active { display: block; }

    h3 { margin: 20px 0 10px 0; font-size: 1.1rem; border-left: 4px solid var(--primary); padding-left: 10px; }
    h3:first-child { margin-top: 0; }
    .card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    input, select, textarea { width:100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; font-size: 16px; }
    button { width:100%; padding: 12px; margin: 8px 0; border-radius: 10px; border:none; background: var(--primary); color:white; font-weight:600; cursor:pointer; transition: 0.2s; }
    button:active { transform: scale(0.98); opacity: 0.9; }
    .smallBtn { width: auto; padding: 6px 12px; font-size: 12px; margin: 4px 2px; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    .routeItem { padding:10px; border-bottom:1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

    @media (max-width: 768px) { 
        body { flex-direction: column; } 
        #map { height: 40vh; flex: none; } 
        #panel { width: 100%; flex: 1; }
    }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('tab-ruta')">üß≠ Ruta</button>
        <button class="tab-btn" onclick="openTab('tab-clientes')">üë• Clientes</button>
        <button class="tab-btn" onclick="openTab('tab-config')">‚öôÔ∏è Login</button>
    </div>

    <div id="tab-ruta" class="tab-content active">
        <h3>Nueva Ruta Diaria</h3>
        <div class="card">
            <label style="font-size: 0.8rem; color: var(--gray);">Fecha de visitas:</label>
            <input type="date" id="routeDate" />
            <select id="startOption">
                <option value="gps">üìç Salir desde mi ubicaci√≥n actual</option>
                <option value="manual">‚úèÔ∏è Salir desde direcci√≥n manual</option>
            </select>
            <input id="startAddress" placeholder="Calle, n√∫mero, ciudad..." style="display:none"/>
            <button id="btnCreateRoute">üß≠ Calcular y Mostrar en Mapa</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button id="btnGoogleMaps" style="background:#34a853">Google Maps</button>
            <button id="btnWaze" style="background:#33ccff">Waze</button>
        </div>
        <button id="btnClearRoute" class="btn-outline">üßπ Limpiar Mapa</button>

        <h3>Historial de Rutas</h3>
        <div id="routeList"></div>
    </div>

    <div id="tab-clientes" class="tab-content">
        <h3>A√±adir Punto de Inter√©s</h3>
        <div class="card">
            <input id="name" placeholder="Nombre (Negocio o Persona)" />
            <input id="address" placeholder="Direcci√≥n opcional" />
            <textarea id="notes" placeholder="Notas: 'comida' o 'hotel' para icono" rows="2"></textarea>
            <div style="display:flex; gap:5px">
                <input id="lat" placeholder="Latitud" />
                <input id="lng" placeholder="Longitud" />
            </div>
            <button id="btnAddClient">‚ûï Guardar en Agenda</button>
        </div>
        <div id="stats" style="font-weight: bold; color: var(--primary); margin-bottom: 10px; font-size: 0.9rem;"></div>
        <div id="clientList"></div>
    </div>

    <div id="tab-config" class="tab-content">
        <h3>Acceso Cloud Sync</h3>
        <div class="card">
            <input id="email" placeholder="Email" />
            <input id="password" type="password" placeholder="Contrase√±a" />
            <button id="btnLogin">üîë Conectar</button>
        </div>
        <small style="color:var(--gray)">Rutas Comerciales PRO v2.5</small>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[], lastRouteClients=[];
let editingClientId = null;
let currentStartOption = "gps"; 

// --- ICONOS ---
const iconNormal = new L.Icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[25,41], iconAnchor:[12,41] });
const iconFood = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/3448/3448609.png", iconSize:[38,38], iconAnchor:[19,38] });
const iconHotel = new L.Icon({ iconUrl: "data:image/svg+xml;base64," + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 38 38"><circle cx="19" cy="19" r="18" fill="#ff9900" stroke="white" stroke-width="2"/><text x="50%" y="55%" font-size="18" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">H</text></svg>`), iconSize:[38,38], iconAnchor:[19,38] });
const iconPin = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32], iconAnchor:[16,32] });

function getClientIcon(c){
    const t=(c.notes||"").toLowerCase();
    if(t.includes("comida")||t.includes("bar")||t.includes("restaurante")) return iconFood;
    if(t.includes("hotel")||t.includes("hostal")) return iconHotel;
    return iconNormal;
}

// --- TABS ---
window.openTab = function(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
}

// --- MAPA ---
let map = L.map('map').setView([40.4168,-3.7038],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

async function geocode(addr){ 
    let res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`); 
    let data=await res.json(); 
    return data.length > 0 ? {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)} : null; 
}

// --- CLIENTES ---
async function cargarClientes(){ 
    const sn=await getDocs(coleccionClientes); 
    clients=sn.docs.map(d=>({...d.data(),id:d.id})).filter(c=>c.name);
    clients.sort((a,b)=>a.name.localeCompare(b.name));
    renderClientes(); 
}

function renderClientes(){ 
    const cont=document.getElementById('clientList'); cont.innerHTML="";
    markers.forEach(m=>map.removeLayer(m)); markers=[];
    clients.forEach((c,i)=>{
        let div=document.createElement('div');
        div.className = "card";
        div.style.padding = "10px";
        div.innerHTML=`<div style="display:flex; align-items:center; gap:10px">
            <input type="checkbox" id="c${i}" style="width:20px; height:20px"> 
            <div style="flex:1">
                <b>${c.name}</b><br>
                <small style="color:gray">${c.address || (c.lat+','+c.lng)}</small>
            </div>
            <button class="smallBtn btn-outline" onclick='editClient("${c.id}")'>‚úèÔ∏è</button>
        </div>`;
        cont.appendChild(div);
        if(c.lat && c.lng){
            let m=L.marker([c.lat,c.lng],{icon:getClientIcon(c)}).addTo(map).bindPopup(c.name);
            m.defaultIcon = getClientIcon(c);
            m.on('click',()=>{ 
                const cb=document.getElementById('c'+i); cb.checked=!cb.checked;
                m.setIcon(cb.checked?iconPin:m.defaultIcon);
            });
            markers.push(m);
        }
    });
    document.getElementById('stats').innerText = `Clientes: ${clients.length}`;
}

window.addClient=async function(){
    const nEl=document.getElementById('name'), aEl=document.getElementById('address'), noEl=document.getElementById('notes'), laEl=document.getElementById('lat'), lnEl=document.getElementById('lng'), btn=document.getElementById('btnAddClient');
    if(!nEl.value) return alert("Nombre obligatorio");
    let lat, lng;
    if(laEl.value && lnEl.value){ lat=parseFloat(laEl.value); lng=parseFloat(lnEl.value); }
    else if(aEl.value){ const co=await geocode(aEl.value); if(!co) return alert("Direcci√≥n no encontrada"); lat=co.lat; lng=co.lng; }
    else { const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j)); lat=pos.coords.latitude; lng=pos.coords.longitude; }

    const d = {name:nEl.value, address:aEl.value, notes:noEl.value, lat, lng};
    if(editingClientId){ await updateDoc(doc(db,"clientes",editingClientId),d); editingClientId=null; btn.innerText='‚ûï Guardar'; }
    else { await addDoc(coleccionClientes, {...d, visits:0}); }
    nEl.value=aEl.value=noEl.value=laEl.value=lnEl.value=""; cargarClientes();
}

window.editClient=function(id){
    const c=clients.find(x=>x.id===id); editingClientId=id;
    document.getElementById('name').value=c.name; document.getElementById('address').value=c.address;
    document.getElementById('notes').value=c.notes; document.getElementById('lat').value=c.lat;
    document.getElementById('lng').value=c.lng; document.getElementById('btnAddClient').innerText='üíæ Actualizar';
    openTab('tab-clientes');
}

window.deleteClient=async function(id){ if(confirm("¬øBorrar punto?")){ await deleteDoc(doc(db,"clientes",id)); cargarClientes(); } }

// --- RUTAS ---
async function cargarRutas(){
    const sn=await getDocs(coleccionRutas); 
    const rts=sn.docs.map(d=>({...d.data(),id:d.id}));
    const cont=document.getElementById('routeList'); cont.innerHTML="";
    rts.sort((a,b)=>b.date.localeCompare(a.date)).forEach(r=>{
        let div=document.createElement('div'); div.className="routeItem";
        div.innerHTML=`<span>üìÖ ${r.date}</span> <div>
            <button class="smallBtn" onclick="loadRoute('${r.id}')">üëÅÔ∏è</button>
            <button class="smallBtn" style="background:var(--danger)" onclick="deleteRoute('${r.id}')">üóëÔ∏è</button>
        </div>`;
        cont.appendChild(div);
    });
}

window.createRoute=async function(){
    let sel=clients.filter((c,i)=>document.getElementById('c'+i)?.checked);
    if(sel.length<1) return alert("Selecciona clientes");
    
    currentStartOption = document.getElementById('startOption').value;
    let sLat, sLng;

    if(currentStartOption==="gps"){
        const p=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j)); sLat=p.coords.latitude; sLng=p.coords.longitude;
    } else {
        const c=await geocode(document.getElementById('startAddress').value); if(!c) return alert("Salida no encontrada"); sLat=c.lat; sLng=c.lng;
    }

    const date=document.getElementById('routeDate').value || new Date().toISOString().split('T')[0];
    lastRouteClients=sel; 
    lastRouteCoords=[[sLat,sLng], ...sel.map(c=>[c.lat,c.lng])];
    
    await addDoc(coleccionRutas,{date, clients:sel.map(c=>c.id), start:{lat:sLat, lng:sLng}, startType: currentStartOption});
    cargarRutas(); drawRoute(lastRouteCoords);
}

function drawRoute(coords){
    if(routeLine) map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
    const str=coords.map(c=>c[1]+","+c[0]).join(";");
    fetch(`https://router.project-osrm.org/trip/v1/driving/${str}?source=first&roundtrip=false&overview=full&geometries=geojson`).then(r=>r.json()).then(d=>{
        routeLine=L.geoJSON(d.trips[0].geometry, {style:{color: '#0ea5e9', weight: 5}}).addTo(map);
        map.fitBounds(routeLine.getBounds().pad(0.2));
        coords.slice(1).forEach(c=> { let m=L.circleMarker(c,{radius:7, color:'red', fillOpacity:1}).addTo(map); redMarkers.push(m); });
    });
}

window.loadRoute=async function(id){
    const sn=await getDocs(coleccionRutas); const r=sn.docs.find(d=>d.id===id).data();
    currentStartOption = r.startType || "gps"; 
    lastRouteClients=clients.filter(c=>r.clients.includes(c.id));
    lastRouteCoords=[[r.start.lat,r.start.lng], ...lastRouteClients.map(c=>[c.lat,c.lng])];
    drawRoute(lastRouteCoords);
}

window.deleteRoute=async function(id){ if(confirm("¬øBorrar?")){ await deleteDoc(doc(db,"rutas",id)); cargarRutas(); } }

// --- GOOGLE MAPS CORREGIDO ---
window.openInGoogleMaps=function(){
    if(lastRouteCoords.length<2) return alert("No hay ruta activa.");
    
    // Si la ruta se cre√≥ con GPS, dejamos origin vac√≠o para que Google Maps use la posici√≥n REAL del m√≥vil en ese momento
    // Si es manual, usamos las coordenadas guardadas.
    let origin = (currentStartOption === "gps") ? "" : lastRouteCoords[0].join(',');
    
    let lastPoint = lastRouteClients[lastRouteClients.length - 1];
    let dest = lastPoint.address ? encodeURIComponent(lastPoint.address) : (lastPoint.lat + ',' + lastPoint.lng);
    
    let waypoints = "";
    if(lastRouteClients.length > 1) {
        waypoints = lastRouteClients.slice(0, -1).map(c => 
            c.address ? encodeURIComponent(c.address) : (c.lat + ',' + c.lng)
        ).join('|');
    }

    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&waypoints=${waypoints}&travelmode=driving`;
    window.open(url, '_blank');
}

window.openInWaze=function(){
    if(lastRouteCoords.length<2) return alert("No hay ruta.");
    let dest=lastRouteCoords[lastRouteCoords.length-1].join(',');
    window.open(`https://waze.com/ul?ll=${dest}&navigate=yes`,'_blank');
}

window.login=async function(){ 
    try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); alert("OK"); cargarClientes(); cargarRutas(); } catch(e){ alert("Error: "+e.message); }
}

document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById('btnAddClient').addEventListener('click',addClient);
    document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
    document.getElementById('btnGoogleMaps').addEventListener('click',openInGoogleMaps);
    document.getElementById('btnWaze').addEventListener('click',window.openInWaze);
    document.getElementById('btnClearRoute').addEventListener('click',() => { if(routeLine) map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); });
    document.getElementById('btnLogin').addEventListener('click',window.login);
    document.getElementById('startOption').addEventListener('change',e=>document.getElementById('startAddress').style.display=e.target.value==="manual"?'block':'none');
    cargarClientes(); cargarRutas();
});
</script>
</body>
</html>
