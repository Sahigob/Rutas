<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO - Calendario</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
#map { flex:1 }
#panel { width:380px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
button:hover { background:#0284c7 }
.client { padding:8px; border-bottom:1px solid #ddd }
.deleteBtn{background:#ef4444;margin-top:6px}
.deleteBtn:hover{background:#dc2626}
input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
small { color:#555 }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
<h3>Login</h3>
<input id="email" placeholder="Correo" />
<input id="password" type="password" placeholder="ContraseÃ±a" />
<button id="btnLogin">ğŸ”‘ Iniciar sesiÃ³n</button>
<hr>

<h3>Clientes</h3>
<input id="name" placeholder="Nombre cliente" />
<input id="address" placeholder="DirecciÃ³n manual (opcional)" />
<textarea id="notes" placeholder="Notas"></textarea>
<input type="date" id="routeDate" />
<input id="lat" placeholder="Latitud (opcional)" />
<input id="lng" placeholder="Longitud (opcional)" />
<button id="btnAddClient">â• Guardar cliente</button>
<button id="btnRoute">ğŸ§­ Calcular y guardar ruta</button>
<button id="btnExport">ğŸ’¾ Exportar clientes</button>
<button id="btnImport">ğŸ“‚ Importar clientes</button>
<button id="btnClearRoute">ğŸ§¹ Borrar ruta seleccionada</button>

<h3>Rutas guardadas</h3>
<div id="savedRoutes"></div>

<h3>Listado de clientes</h3>
<div id="clientList"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const firebaseConfig = { apiKey:"AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain:"rutas-56f86.firebaseapp.com", projectId:"rutas-56f86", storageBucket:"rutas-56f86.appspot.com", messagingSenderId:"1026881492897", appId:"1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const coleccionClientes = db.collection('clientes');

let clients = [], markers = [], redMarkers = [], routeLine;
let rutasGuardadas = {};

let map = L.map('map').setView([40.4168, -3.7038], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// LOGIN
function login(){
  const correo=document.getElementById('email').value;
  const contrasena=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(correo, contrasena)
    .then(user=>{ alert('Login exitoso: '+user.user.email); cargarClientes(); })
    .catch(e=>alert('Error login: '+e.message));
}

// AGREGAR CLIENTE
async function addClient(){
  const name=document.getElementById('name').value;
  const address=document.getElementById('address').value;
  const notes=document.getElementById('notes').value;
  const latInput=document.getElementById('lat').value;
  const lngInput=document.getElementById('lng').value;
  if(!name) return alert('Pon nombre');

  let lat,lng;
  if(latInput && lngInput){ lat=parseFloat(latInput); lng=parseFloat(lngInput); }
  else if(address){ const coords=await geocode(address); if(!coords) return alert('No se encontrÃ³ direcciÃ³n'); lat=coords.lat; lng=coords.lng; }
  else{ try{ const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej)); lat=pos.coords.latitude; lng=pos.coords.longitude; } catch(e){ return alert('No se pudo obtener ubicaciÃ³n'); } }

  await coleccionClientes.add({name,address,lat,lng,notes});
  cargarClientes();
}

// CARGAR CLIENTES
async function cargarClientes(){
  const snapshot = await coleccionClientes.get();
  clients = snapshot.docs.map(d=>({...d.data(), id:d.id}));
  renderClientes();
}

function renderClientes(){
  const list=document.getElementById('clientList'); list.innerHTML='';
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  clients.forEach((c,i)=>{
    let div=document.createElement('div'); div.className='client';
    div.innerHTML=`<input type=checkbox id=c${i}> <b>${c.name}</b><br><small>${c.address||c.lat+', '+c.lng}</small><br><small>ğŸ“ ${c.notes||''}</small>`;
    list.appendChild(div);
    if(c.lat && c.lng){ let m=L.marker([c.lat,c.lng]).addTo(map).bindPopup(c.name); markers.push(m); }
  });
}

// GEOCODING
async function geocode(address){
  let res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
  let data=await res.json();
  if(data.length>0) return {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)};
  return null;
}

// CALCULAR Y GUARDAR RUTA
function calculateRoute(){
  let selected=[];
  clients.forEach((c,i)=>{ if(document.getElementById('c'+i)?.checked) selected.push(c); });
  if(selected.length<1) return alert('Selecciona clientes');

  const fecha=document.getElementById('routeDate').value;
  if(!fecha) return alert('Selecciona una fecha');

  navigator.geolocation.getCurrentPosition(async pos=>{
    let coords=[[pos.coords.longitude,pos.coords.latitude],...selected.map(c=>[c.lng,c.lat])];
    let coordString=coords.map(c=>c.join(',')).join(';');
    let url=`https://router.project-osrm.org/trip/v1/driving/${coordString}?source=first&roundtrip=false&overview=full&geometries=geojson`;
    let res=await fetch(url); let data=await res.json();

    if(routeLine) map.removeLayer(routeLine);
    redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];

    routeLine=L.geoJSON(data.trips[0].geometry).addTo(map);
    map.fitBounds(routeLine.getBounds());

    selected.forEach(c=>{ let m=L.circleMarker([c.lat,c.lng],{radius:8,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map); redMarkers.push(m); });

    rutasGuardadas[fecha]={ coords:coords, geojson:data.trips[0].geometry, clientes:selected.map(c=>c.id) };
    renderRutasGuardadas();
  });
}

function renderRutasGuardadas(){
  const container=document.getElementById('savedRoutes'); container.innerHTML='';
  Object.keys(rutasGuardadas).sort().forEach(fecha=>{
    let div=document.createElement('div'); div.style.marginBottom='6px';
    div.innerHTML=`<button onclick='cargarRuta("${fecha}")'>ğŸ“… ${fecha}</button> <button class='deleteBtn' onclick='borrarRuta("${fecha}")'>ğŸ—‘ï¸</button>`;
    container.appendChild(div);
  });
}

function cargarRuta(fecha){
  if(!rutasGuardadas[fecha]) return;
  if(routeLine) map.removeLayer(routeLine);
  redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];

  const ruta=rutasGuardadas[fecha];
  routeLine=L.geoJSON(ruta.geojson).addTo(map);
  map.fitBounds(routeLine.getBounds());
  ruta.coords.slice(1).forEach(c=>{ let m=L.circleMarker([c[1],c[0]],{radius:8,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map); redMarkers.push(m); });
}

function borrarRuta(fecha){
  if(!confirm('Â¿Borrar ruta de '+fecha+'?')) return;
  if(routeLine) map.removeLayer(routeLine); routeLine=null;
  redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
  delete rutasGuardadas[fecha];
  renderRutasGuardadas();
}

// EVENT LISTENERS
document.getElementById('btnLogin').addEventListener('click',login);
document.getElementById('btnAddClient').addEventListener('click',addClient);
document.getElementById('btnRoute').addEventListener('click',calculateRoute);
document.getElementById('btnClearRoute').addEventListener('click',()=>{ if(routeLine) map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); routeLine=null; redMarkers=[]; });
</script>
</body>
</html>
