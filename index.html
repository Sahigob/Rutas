<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rutas Comerciales PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
    #map { flex:1 }
    #panel { width:400px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
    button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
    button:hover { background:#0284c7 }
    .deleteBtn{background:#ef4444;margin-top:6px}
    .deleteBtn:hover{background:#dc2626}
    input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
    small { color:#555 }
    .routeItem{padding:6px; border-bottom:1px solid #ccc; margin-bottom:4px;}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Login</h3>
    <input id="email" placeholder="Correo" />
    <input id="password" type="password" placeholder="ContraseÃ±a" />
    <button id="btnLogin">ğŸ”‘ Iniciar sesiÃ³n</button>
    <hr>

    <h3>Clientes</h3>
    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="DirecciÃ³n manual (opcional)" />
    <textarea id="notes" placeholder="Notas"></textarea>
    <input id="lat" placeholder="Latitud (opcional)" />
    <input id="lng" placeholder="Longitud (opcional)" />
    <button id="btnAddClient">â• Guardar cliente</button>
    <button id="btnExport">ğŸ’¾ Exportar clientes</button>
    <button id="btnImport">ğŸ“‚ Importar clientes</button>

    <h3>Rutas</h3>
    <button id="btnRoute">ğŸ§­ Crear nueva ruta</button>
    <button id="btnClearRoute">ğŸ§¹ Borrar ruta y marcadores rojos</button>
    <div id="routeList"></div>

    <h3>EstadÃ­sticas</h3>
    <div id="stats"></div>

    <h3>Listado de Clientes</h3>
    <div id="clientList"></div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE",
  authDomain: "rutas-56f86.firebaseapp.com",
  projectId: "rutas-56f86",
  storageBucket: "rutas-56f86.appspot.com",
  messagingSenderId: "1026881492897",
  appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db, "clientes");
const coleccionRutas = collection(db, "rutas");

let clients = [];
let markers = [];
let redMarkers = [];
let routeLine;
let lastRouteCoords = [];

let map = L.map('map').setView([40.4168,-3.7038],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// --- LOGIN ---
window.login = async function() {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  try{
    const userCredential = await signInWithEmailAndPassword(auth,email,pass);
    alert("Login correcto: "+userCredential.user.email);
    await cargarClientes();
    await cargarRutas();
  }catch(err){
    alert("Error login: "+err.message);
  }
};

// --- CLIENTES ---
async function cargarClientes(){
  const snapshot = await getDocs(coleccionClientes);
  clients = snapshot.docs.map(d=>({...d.data(),id:d.id}));
  clients.sort((a,b)=>a.name.localeCompare(b.name));
  renderClientes();
}

window.addClient = async function(){
  const name = document.getElementById('name').value;
  const address = document.getElementById('address').value;
  const notes = document.getElementById('notes').value;
  const latInput = document.getElementById('lat').value;
  const lngInput = document.getElementById('lng').value;
  if(!name) return alert("Pon nombre del cliente");

  let lat,lng;
  if(latInput && lngInput){
    lat=parseFloat(latInput); lng=parseFloat(lngInput);
  } else if(address){
    const coords = await geocode(address);
    if(!coords) return alert("No se encontrÃ³ direcciÃ³n");
    lat=coords.lat; lng=coords.lng;
  } else {
    try{
      const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
      lat=pos.coords.latitude; lng=pos.coords.longitude;
    }catch(err){
      return alert("No se pudo obtener ubicaciÃ³n");
    }
  }

  await addDoc(coleccionClientes,{name,address,lat,lng,notes,visits:0});
  await cargarClientes();
}

window.deleteClient = async function(id){
  if(!confirm("Borrar cliente?")) return;
  await deleteDoc(doc(db,"clientes",id));
  await cargarClientes();
}

function renderClientes(){
  document.getElementById('clientList').innerHTML="";
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  clients.forEach((c,i)=>{
    let div = document.createElement('div'); div.className="client";
    div.innerHTML=`
      <input type=checkbox id=c${i}> <b>${c.name}</b><br>
      <small>${c.address || (c.lat?.toFixed(5)+','+c.lng?.toFixed(5))}</small><br>
      <small>ğŸ“ ${c.notes||''}</small><br>
      <small>Visitas: ${c.visits||0}</small>
      <button class='deleteBtn' onclick='deleteClient("${c.id}")'>ğŸ—‘ï¸ Borrar</button>
    `;
    document.getElementById('clientList').appendChild(div);
    if(c.lat && c.lng){
      let m=L.marker([c.lat,c.lng]).addTo(map).bindPopup(c.name);
      markers.push(m);
    }
  });
  let totalVisits = clients.reduce((sum,c)=>sum+(c.visits||0),0);
  document.getElementById('stats').innerHTML=`Clientes totales: ${clients.length}<br>Total visitas: ${totalVisits}`;
}

// --- GEOCODING ---
async function geocode(address){
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
  const data = await res.json();
  if(data.length>0) return {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)};
  return null;
}

// --- RUTAS ---
async function cargarRutas(){
  const snapshot = await getDocs(coleccionRutas);
  const rutas = snapshot.docs.map(d=>({...d.data(),id:d.id}));
  const container = document.getElementById('routeList');
  container.innerHTML="";
  rutas.sort((a,b)=>a.date.localeCompare(b.date));
  rutas.forEach(r=>{
    const existingClients = clients.filter(c=>r.clients.includes(c.id));
    if(existingClients.length===0) return;
    let div = document.createElement('div'); div.className="routeItem";
    div.innerHTML=`${r.date} 
      <button onclick="loadRoute('${r.id}')">ğŸŸ¢ Ver</button>
      <button onclick="deleteRoute('${r.id}')">ğŸ—‘ï¸</button>`;
    container.appendChild(div);
  });
}

window.loadRoute = async function(id){
  const snapshot = await getDocs(coleccionRutas);
  const routeDoc = snapshot.docs.find(d=>d.id===id);
  if(!routeDoc) return alert("Ruta no encontrada");
  const data = routeDoc.data();
  const selectedClients = clients.filter(c=>data.clients.includes(c.id));
  if(selectedClients.length===0) return alert("No hay clientes disponibles para esta ruta");

  const coords=[[data.start.lat,data.start.lng],...selectedClients.map(c=>[c.lat,c.lng])];
  lastRouteCoords = coords;
  drawRoute(coords);
};

window.deleteRoute = async function(id){
  if(!confirm("Borrar ruta?")) return;
  await deleteDoc(doc(db,"rutas",id));
  await cargarRutas();
};

// --- CREAR RUTA ---
window.calculateRoute = async function(){
  const selectedClients = clients.filter((c,i)=>document.getElementById('c'+i)?.checked);
  if(selectedClients.length<1) return alert("Selecciona clientes");

  let start;
  const tipo = prompt("Ruta desde:\n1: Mi ubicaciÃ³n actual\n2: Ingresar direcciÃ³n manual");
  if(tipo==="1"){
    try{
      const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
      start={lat:pos.coords.latitude,lng:pos.coords.longitude};
    }catch(err){ return alert("No se pudo obtener ubicaciÃ³n"); }
  } else if(tipo==="2"){
    const addr = prompt("Introduce direcciÃ³n de inicio");
    const coords = await geocode(addr);
    if(!coords) return alert("No se encontrÃ³ direcciÃ³n");
    start=coords;
  } else return alert("Cancelado");

  const coords = [[start.lng,start.lat],...selectedClients.map(c=>[c.lng,c.lat])];
  lastRouteCoords = coords;
  drawRoute([[start.lat,start.lng], ...selectedClients.map(c=>[c.lat,c.lng])]);

  // Guardar ruta en Firebase
  const date = prompt("Fecha de la ruta (yyyy-mm-dd)");
  if(!date) return alert("No se guardÃ³");
  const rutaDoc = {date, start, clients:selectedClients.map(c=>c.id)};
  await addDoc(coleccionRutas,rutaDoc);
  await cargarRutas();
}

// --- DIBUJAR RUTA ---
function drawRoute(coords){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  redMarkers.forEach(m=>map.removeLayer(m));
  redMarkers=[];
  const latlngs=coords.map(c=>[c[1],c[0]]);
  routeLine=L.polyline(latlngs,{color:'red',weight:4}).addTo(map);
  latlngs.forEach(c=>{
    let m=L.circleMarker(c,{radius:6,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map);
    redMarkers.push(m);
  });
  map.fitBounds(routeLine.getBounds());
}

// --- GOOGLE MAPS / WAZE ---
window.openInGoogleMaps = function(){
  if(lastRouteCoords.length<2) return alert("Calcula ruta primero");
  const origin=lastRouteCoords[0].slice().reverse().join(',');
  const waypoints=lastRouteCoords.slice(1).map(c=>c.slice().reverse().join(',')).join('|');
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&waypoints=${waypoints}`,'_blank');
}
window.openInWaze = function(){
  if(lastRouteCoords.length<2) return alert("Calcula ruta primero");
  const dest=lastRouteCoords[lastRouteCoords.length-1].slice().reverse().join(',');
  window.open(`https://waze.com/ul?ll=${dest}&navigate=yes`,'_blank');
}

// --- EXPORT / IMPORT CLIENTES ---
window.exportClients = function(){
  const dataStr = JSON.stringify(clients,null,2);
  const blob=new Blob([dataStr],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='clientes_backup.json'; a.click();
  URL.revokeObjectURL(url);
}
window.importClients = function(){
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=async ()=>{
      try{
        const imported=JSON.parse(reader.result);
        if(Array.isArray(imported)){
          for(const c of imported) await addDoc(coleccionClientes,c);
          await cargarClientes();
          alert("Clientes importados correctamente");
        } else alert("Archivo no vÃ¡lido");
      } catch(err){ alert("Error leyendo archivo"); }
    };
    reader.readAsText(file);
  };
  input.click();
}

// --- BORRAR RUTA ---
window.clearRoute=function(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
  lastRouteCoords=[];
}

// --- EVENTOS ---
document.getElementById('btnLogin').addEventListener('click',window.login);
document.getElementById('btnAddClient').addEventListener('click',window.addClient);
document.getElementById('btnRoute').addEventListener('click',window.calculateRoute);
document.getElementById('btnClearRoute').addEventListener('click',window.clearRoute);

</script>
</body>
</html>
