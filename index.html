<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rutas</title>
</head>
<body>

<h1>Gestor de Rutas</h1>

<h2>Nuevo Cliente</h2>
<input id="nombre" placeholder="Nombre">
<input id="localidad" placeholder="Localidad">
<input id="direccion" placeholder="Direccion">
<input id="telefono" placeholder="Telefono">
<button id="btnGuardar">Guardar Cliente</button>

<h2>Clientes</h2>
<div id="listaClientes"></div>

<hr>

<h2>Ruta</h2>

<select id="dia">
<option value="lunes">Lunes</option>
<option value="martes">Martes</option>
<option value="miercoles">Miércoles</option>
<option value="jueves">Jueves</option>
<option value="viernes">Viernes</option>
</select>

<button id="btnBorrarRuta">Borrar ruta del día</button>

<h3>Ruta del día</h3>
<div id="rutaHoy"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE",
  authDomain: "rutas-56f86.firebaseapp.com",
  projectId: "rutas-56f86",
  storageBucket: "rutas-56f86.firebasestorage.app",
  messagingSenderId: "1026881492897",
  appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let clientesCache = [];

// ================= GUARDAR CLIENTE =================
document.getElementById("btnGuardar").addEventListener("click", async ()=>{

  const nombre = document.getElementById("nombre").value.trim();
  const localidad = document.getElementById("localidad").value.trim();
  const direccion = document.getElementById("direccion").value.trim();
  const telefono = document.getElementById("telefono").value.trim();

  if(!nombre) return alert("Introduce nombre");

  await addDoc(collection(db,"clientes"),{
    nombre, localidad, direccion, telefono
  });

  document.getElementById("nombre").value="";
  document.getElementById("localidad").value="";
  document.getElementById("direccion").value="";
  document.getElementById("telefono").value="";

  cargarClientes();
});

// ================= CARGAR CLIENTES =================
async function cargarClientes(){

  const cont = document.getElementById("listaClientes");
  cont.innerHTML="Cargando...";

  const snap = await getDocs(collection(db,"clientes"));

  clientesCache=[];
  snap.forEach(d=>{
    clientesCache.push({id:d.id,...d.data()});
  });

  // Ordenar por localidad y nombre
  clientesCache.sort((a,b)=>{
    if(a.localidad === b.localidad)
      return a.nombre.localeCompare(b.nombre);
    return a.localidad.localeCompare(b.localidad);
  });

  cont.innerHTML="";
  let locActual="";

  clientesCache.forEach(c=>{

    if(c.localidad !== locActual){
      locActual = c.localidad;
      cont.innerHTML += `<h4>${locActual}</h4>`;
    }

    const div = document.createElement("div");
    div.innerHTML = `
      ${c.nombre} - ${c.direccion}
      <button data-id="${c.id}">Añadir</button>
    `;

    div.querySelector("button").addEventListener("click",()=>{
      añadirARuta(c.id);
    });

    cont.appendChild(div);
  });
}

// ================= AÑADIR A RUTA =================
async function añadirARuta(id){

  const dia = document.getElementById("dia").value;
  const ref = doc(db,"rutas",dia);

  const snap = await getDoc(ref);
  let clientes=[];

  if(snap.exists()) clientes = snap.data().clientes || [];

  if(!clientes.includes(id)) clientes.push(id);

  await setDoc(ref,{clientes},{merge:true});

  cargarRuta();
}

// ================= CARGAR RUTA =================
async function cargarRuta(){

  const dia = document.getElementById("dia").value;
  const cont = document.getElementById("rutaHoy");
  cont.innerHTML="Cargando...";

  const snap = await getDoc(doc(db,"rutas",dia));

  if(!snap.exists()){
    cont.innerHTML="No hay ruta";
    return;
  }

  const ruta = snap.data().clientes || [];

  cont.innerHTML="";

  ruta.forEach(id=>{
    const c = clientesCache.find(x=>x.id===id);
    if(c){
      cont.innerHTML += `<div>${c.nombre} - ${c.localidad}</div>`;
    }
  });
}

// ================= BORRAR RUTA =================
document.getElementById("btnBorrarRuta").addEventListener("click", async ()=>{
  const dia = document.getElementById("dia").value;
  await deleteDoc(doc(db,"rutas",dia));
  cargarRuta();
});

// ================= INICIO =================
document.getElementById("dia").addEventListener("change", cargarRuta);

window.onload = async ()=>{
  await cargarClientes();
  await cargarRuta();
};

</script>

</body>
</html>
