<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO v2.5 - Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<style>
:root {
  --primary: #0ea5e9;
  --primary-dark: #0284c7;
  --bg: #f8fafc;
  --card-bg: #ffffff;
  --text: #1e293b;
  --border: #e2e8f0;
}

body { margin:0; font-family: 'Segoe UI', system-ui, sans-serif; display:flex; flex-direction: row; height:100vh; background: var(--bg); color: var(--text); }
#map { flex:1; height: 100%; z-index: 1; }
#panel { width:400px; padding:24px; overflow-y:auto; background: var(--card-bg); border-left: 1px solid var(--border); box-sizing: border-box; box-shadow: -4px 0 15px rgba(0,0,0,0.05); z-index: 10; }

@media (max-width: 768px) { 
  body { flex-direction: column; } 
  #map { flex: none; height: 35vh; } 
  #panel { width: 100%; flex: 1; border-left: none; border-top: 2px solid var(--border); }
}

h3 { margin: 24px 0 12px 0; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
h3::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 4px; }

.card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }

button { 
  width:100%; padding:12px; margin:8px 0; border-radius:10px; border:none; background: var(--primary); color:white; 
  font-weight:600; cursor:pointer; font-size: 14px; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
}
button:hover { background: var(--primary-dark); }
button:active { transform: scale(0.98); }

#btnRutaOrdenEstricto { background-color: #ffc107; color: #212529; border: 2px solid #e0a800; }

.smallBtn { padding:6px 12px; font-size:12px; margin: 4px 2px; width: auto; display: inline-flex; }
.deleteBtn { background:#ef4444; }
.saveBtn { background: #22c55e; }

input, select, textarea { 
  width:100%; margin:8px 0; padding:12px; border-radius:10px; border:1px solid var(--border); box-sizing: border-box; font-size: 14px; 
}

.client { padding:12px; border: 1px solid var(--border); background: white; margin-bottom: 8px; border-radius: 10px; }
.edit-mode { border: 2px solid var(--primary); background: #f0f9ff; }
.stats-badge { background: #e0f2fe; color: #0369a1; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }
label { font-weight: 600; font-size: 13px; margin-bottom: 4px; display: block; }
input[type="checkbox"] { width: auto; transform: scale(1.4); margin-right: 12px; cursor: pointer; }

.routeItem { 
    display:flex; justify-content:space-between; align-items:center; 
    margin-bottom:8px; font-size:13px; background:#f1f5f9; 
    padding:8px 12px; border-radius:10px; border:1px solid #e2e8f0;
}

.debug-box { background: #1e293b; color: #38bdf8; font-family: monospace; padding: 10px; border-radius: 8px; font-size: 11px; margin-top: 10px; white-space: pre-wrap; display: none; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <div class="card">
    <h3>üîê Login</h3>
    <input id="email" placeholder="Correo electr√≥nico" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Iniciar sesi√≥n</button>
  </div>

  <div class="card">
    <h3>üë• Gesti√≥n de Cliente</h3>
    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="Direcci√≥n manual" />
    <textarea id="notes" placeholder="Notas (ej: Hotel, Restaurante, Peaje...)" rows="2"></textarea>
    <div style="display:flex; gap:8px">
        <input id="lat" placeholder="Latitud" />
        <input id="lng" placeholder="Longitud" />
    </div>
    <button id="btnAddClient">‚ûï Guardar cliente</button>
  </div>

  <div class="card">
    <h3>üß≠ Planificador de Ruta</h3>
    <label>Fecha:</label>
    <input type="date" id="routeDate" />
    <label>Salida:</label>
    <select id="startOption">
      <option value="gps">üìç Mi ubicaci√≥n actual</option>
      <option value="manual">‚úèÔ∏è Direcci√≥n manual</option>
    </select>
    <input id="startAddress" placeholder="Direcci√≥n de salida" style="display:none"/>
    <button id="btnCreateRoute">üß≠ Crear ruta azul</button>
    <div id="debugOrder" class="debug-box"></div>
    <div id="routeList"></div>
  </div>

  <div class="card">
    <h3>üöó Navegaci√≥n</h3>
    <button id="btnRutaOrdenEstricto"><i class="fas fa-route"></i> Google (Orden de Lista)</button>
    <button id="btnGoogleMaps" style="background: #22c55e;">üåê Google (Optimizado)</button>
    <button id="btnWaze" style="background: #1e40af;">üõ£Ô∏è Abrir Waze</button>
    <button id="btnClearRoute" style="background: #64748b;">üßπ Limpiar mapa</button>
  </div>

  <h3>üìä Clientes <span id="stats" class="stats-badge">0</span></h3>
  <div id="clientList"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const colClientes = collection(db,"clientes");
const colRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[];
let editingClientId = null;

// Iconos personalizados
const iconNormal = new L.Icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", iconSize:[25,41], iconAnchor:[12,41] });
const iconFood = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/3448/3448609.png", iconSize:[30,30], iconAnchor:[15,30] });
const iconHotel = new L.Icon({ iconUrl: "data:image/svg+xml;base64," + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"><circle cx="15" cy="15" r="14" fill="#ff9900" stroke="white" stroke-width="2"/><text x="50%" y="55%" font-size="14" text-anchor="middle" font-family="Arial" font-weight="bold" dominant-baseline="middle">H</text></svg>`), iconSize:[30,30], iconAnchor:[15,30] });
const iconPeaje = new L.Icon({ iconUrl: "data:image/svg+xml;base64," + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"><circle cx="15" cy="15" r="14" fill="#ffc107" stroke="#333" stroke-width="2"/><text x="50%" y="60%" font-size="16" text-anchor="middle" dominant-baseline="middle">üõ£Ô∏è</text></svg>`), iconSize:[30,30], iconAnchor:[15,30] });
const iconPin = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32], iconAnchor:[16,32] });
const iconUser = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[40,40], iconAnchor:[20,40] });

let map = L.map('map').setView([40.41,-3.70], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function getClientIcon(c){
  const n = (c.notes||"").toLowerCase();
  if(n.includes("peaje")) return iconPeaje;
  if(n.includes("comida")||n.includes("restaurante")) return iconFood;
  if(n.includes("hotel")||n.includes("dormir")) return iconHotel;
  return iconNormal;
}

// FUNCIONES DE CLIENTE
window.cargarClientes = async () => {
  const snap = await getDocs(colClientes);
  clients = snap.docs.map(d => ({...d.data(), id:d.id}));
  clients.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  renderClientes();
};

function renderClientes(){
  const container = document.getElementById('clientList');
  container.innerHTML = "";
  markers.forEach(m => map.removeLayer(m)); markers = [];

  clients.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'client';
    if(editingClientId === c.id){
      div.classList.add('edit-mode');
      div.innerHTML = `<input id="e_n" value="${c.name}"><input id="e_a" value="${c.address}"><textarea id="e_nt">${c.notes||''}</textarea>
                       <button class="smallBtn saveBtn" onclick="window.saveEdit('${c.id}')">üíæ</button><button class="smallBtn" onclick="window.cancelEdit()">‚ùå</button>`;
    } else {
      div.innerHTML = `<div style="display:flex; align-items:center;"><input type="checkbox" id="c${i}"> <div style="flex:1"><b>${c.name}</b><br><small>${c.address}</small></div></div>
                       <div style="margin-top:5px"><button class="smallBtn" onclick="window.editMode('${c.id}')">‚úèÔ∏è</button><button class="smallBtn deleteBtn" onclick="window.delClient('${c.id}')">üóëÔ∏è</button></div>`;
    }
    container.appendChild(div);
    if(c.lat){
      const m = L.marker([c.lat, c.lng], {icon: getClientIcon(c)}).addTo(map).bindPopup(c.name);
      m.on('click', () => { document.getElementById('c'+i).checked = !document.getElementById('c'+i).checked; });
      markers.push(m);
    }
  });
  document.getElementById('stats').innerText = clients.length;
}

// LOGICA DE BOTONES
window.editMode = (id) => { editingClientId = id; renderClientes(); };
window.cancelEdit = () => { editingClientId = null; renderClientes(); };
window.delClient = async (id) => { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db,"clientes",id)); cargarClientes(); } };
window.saveEdit = async (id) => {
  const name=document.getElementById('e_n').value, address=document.getElementById('e_a').value, notes=document.getElementById('e_nt').value;
  await updateDoc(doc(db,"clientes",id), {name, address, notes});
  editingClientId = null; cargarClientes();
};

window.addClient = async () => {
  const name=document.getElementById('name').value, address=document.getElementById('address').value, notes=document.getElementById('notes').value, latIn=document.getElementById('lat').value, lngIn=document.getElementById('lng').value;
  let lat=parseFloat(latIn), lng=parseFloat(lngIn);
  if(!lat){ const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${address}`); const d=await res.json(); if(d[0]){ lat=parseFloat(d[0].lat); lng=parseFloat(d[0].lon); } }
  await addDoc(colClientes, {name, address, notes, lat, lng});
  cargarClientes();
};

window.createRoute = async () => {
  let sel = clients.filter((c,i) => document.getElementById('c'+i)?.checked);
  if(sel.length < 1) return alert("Selecciona puntos");
  
  let start = userMarker ? [userMarker.getLatLng().lat, userMarker.getLatLng().lng] : [40.41, -3.70];
  const pts = [start, ...sel.map(c => [c.lat, c.lng])];
  const str = pts.map(p => `${p[1]},${p[0]}`).join(';');
  
  const res = await fetch(`https://router.project-osrm.org/trip/v1/driving/${str}?source=first&destination=last&roundtrip=false&overview=full&geometries=geojson`);
  const data = await res.json();
  if(data.waypoints){
    lastRouteCoords = data.waypoints.sort((a,b)=>a.waypoint_index-b.waypoint_index).map(w=>[w.location[1],w.location[0]]);
    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.geoJSON(data.trips[0].geometry, {style: {color: '#0ea5e9', weight: 5}}).addTo(map);
    map.fitBounds(routeLine.getBounds());
    document.getElementById('debugOrder').style.display="block";
    document.getElementById('debugOrder').innerText = "Ruta OK. Puntos ordenados.";
  }
};

window.openNav = (estricto) => {
  if(lastRouteCoords.length < 2) return alert("Crea la ruta azul");
  const origin = lastRouteCoords[0].join(',');
  const dest = lastRouteCoords[lastRouteCoords.length-1].join(',');
  const way = lastRouteCoords.slice(1,-1).map(c=>c.join(',')).join('|');
  const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&waypoints=${encodeURIComponent(way)}&travelmode=driving`;
  window.open(url, '_blank');
};

window.login = async () => {
  try {
    await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    alert("¬°Conectado!"); cargarClientes();
  } catch(e){ alert("Error: " + e.message); }
};

// INICIALIZACION
document.getElementById('btnLogin').onclick = window.login;
document.getElementById('btnAddClient').onclick = window.addClient;
document.getElementById('btnCreateRoute').onclick = window.createRoute;
document.getElementById('btnRutaOrdenEstricto').onclick = () => window.openNav(true);
document.getElementById('btnGoogleMaps').onclick = () => window.openNav(false);
document.getElementById('btnClearRoute').onclick = () => { if(routeLine) map.removeLayer(routeLine); };

navigator.geolocation.getCurrentPosition(p => {
  const lat=p.coords.latitude, lng=p.coords.longitude;
  map.setView([lat,lng], 12);
  userMarker = L.marker([lat,lng], {icon:iconUser}).addTo(map);
}, () => cargarClientes());

cargarClientes();
</script>
</body>
</html>
