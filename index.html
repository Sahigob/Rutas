<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Ruta Estricta OSM a Google</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #0ea5e9; --bg: #f1f5f9; }
        body { margin:0; font-family: -apple-system, sans-serif; display:flex; flex-direction: column; height:100vh; background: var(--bg); }
        #map { flex: 1; min-height: 300px; }
        #panel { height: 400px; overflow-y: auto; background: white; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        @media (min-width: 768px) {
            body { flex-direction: row; }
            #map { flex: 1; }
            #panel { width: 400px; height: 100vh; }
        }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-yellow { background: #ffc107; color: #000; }
        .debug-box { background: #1e293b; color: #38bdf8; font-family: monospace; padding: 10px; border-radius: 8px; font-size: 11px; margin-top: 10px; white-space: pre-wrap; }
        .client-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .client-item input { margin-right: 12px; transform: scale(1.3); }
    </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <div class="card">
        <h3>Л 1. Generar Trayecto</h3>
        <p style="font-size: 13px; color: #64748b;">Selecciona clientes y presiona el bot贸n azul para ver el orden de OpenStreetMap.</p>
        <button id="btnOSM" class="btn-blue">CALCULAR RUTA OSM</button>
        
        <div id="debugOrder" class="debug-box">El orden aparecer谩 aqu铆...</div>
    </div>

    <div class="card">
        <h3> 2. Navegaci贸n</h3>
        <button id="btnGoogle" class="btn-yellow">ABRIR EN GOOGLE MAPS</button>
    </div>

    <div id="clientList" class="card">
        <strong>Cargando clientes de Firebase...</strong>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    // Tu Configuraci贸n (No cambiar)
    const firebaseConfig = { 
        apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", 
        authDomain: "rutas-56f86.firebaseapp.com", 
        projectId: "rutas-56f86", 
        storageBucket: "rutas-56f86.appspot.com", 
        messagingSenderId: "1026881492897", 
        appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let clients = [];
    let lastRouteCoords = [];

    // Mapa inicial
    const map = L.map('map').setView([40.4168, -3.7038], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 1. Cargar Clientes
    async function init() {
        const querySnapshot = await getDocs(collection(db, "clientes"));
        const listDiv = document.getElementById('clientList');
        listDiv.innerHTML = "<h4>Seleccionar Clientes:</h4>";
        
        clients = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(c => c.lat);
        
        clients.forEach((c, i) => {
            const item = document.createElement('div');
            item.className = 'client-item';
            item.innerHTML = `<input type="checkbox" class="c-check" data-idx="${i}"> <span>${c.name}</span>`;
            listDiv.appendChild(item);
            L.marker([c.lat, c.lng]).addTo(map).bindPopup(c.name);
        });
    }

    // 2. Calcular con OpenStreetMap (OSRM)
    document.getElementById('btnOSM').onclick = async () => {
        let sel = [];
        document.querySelectorAll('.c-check:checked').forEach(cb => {
            sel.push(clients[cb.dataset.idx]);
        });

        if (sel.length === 0) return alert("Selecciona al menos un cliente");

        // Punto de salida (Madrid Centro por defecto)
        const start = [40.4168, -3.7038]; 
        const coords = [start, ...sel.map(c => [c.lat, c.lng])];
        
        // Llamada a OSRM respetando el orden de selecci贸n
        const strCoords = coords.map(p => `${p[1]},${p[0]}`).join(';');
        const url = `https://router.project-osrm.org/trip/v1/driving/${strCoords}?source=first&destination=last&roundtrip=false&overview=full&geometries=geojson`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.waypoints) {
                // Ordenar seg煤n el 铆ndice de waypoint que devuelve OSM
                lastRouteCoords = data.waypoints
                    .sort((a, b) => a.waypoint_index - b.waypoint_index)
                    .map(w => [w.location[1], w.location[0]]);

                // Debug Visual
                const debugDiv = document.getElementById('debugOrder');
                debugDiv.innerHTML = "ORDEN CALCULADO:\n" + lastRouteCoords.map((c, idx) => {
                    return `${idx}. ${idx === 0 ? 'Salida' : 'Cliente'} (${c[0].toFixed(3)}, ${c[1].toFixed(3)})`;
                }).join('\n');

                // Pintar en mapa
                if (window.routeLayer) map.removeLayer(window.routeLayer);
                window.routeLayer = L.geoJSON(data.trips[0].geometry, { style: { color: '#0ea5e9', weight: 5 } }).addTo(map);
                map.fitBounds(window.routeLayer.getBounds());
            }
        } catch (e) {
            alert("Error calculando ruta");
        }
    };

    // 3. Abrir en Google Maps (Orden Forzado)
    document.getElementById('btnGoogle').onclick = () => {
        if (lastRouteCoords.length < 2) return alert("Calcula primero la ruta azul");

        const origin = `${lastRouteCoords[0][0]},${lastRouteCoords[0][1]}`;
        const destination = `${lastRouteCoords[lastRouteCoords.length - 1][0]},${lastRouteCoords[lastRouteCoords.length - 1][1]}`;
        
        // Usamos los intermedios exactamente como los dio OSM
        let waypoints = "";
        if (lastRouteCoords.length > 2) {
            waypoints = lastRouteCoords.slice(1, -1).map(c => `${c[0]},${c[1]}`).join('|');
        }

        // Construcci贸n de URL universal (Funciona en PC y App M贸vil)
        const googleUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${encodeURIComponent(waypoints)}&travelmode=driving`;
        
        window.open(googleUrl, '_blank');
    };

    init();
</script>
</body>
</html>
