<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RUTAS</title>
<style>
body{font-family:Arial;margin:20px;background:#f2f2f2}
h2{margin-top:40px}
input,select,button{padding:6px;margin:4px}
.cliente{background:white;padding:6px;margin:4px;border-radius:6px}
.localidad{background:#ddd;padding:5px;margin-top:15px;font-weight:bold}
.ruta{background:#d9ffd9;padding:6px;margin:3px;border-radius:6px}
</style>
</head>

<body>

<h1>GESTOR DE RUTAS</h1>

<!-- ================== CLIENTES ================== -->
<h2>Nuevo Cliente</h2>
<input id="nombre" placeholder="Nombre">
<input id="localidad" placeholder="Localidad">
<input id="direccion" placeholder="Direccion">
<input id="telefono" placeholder="Telefono">
<button onclick="guardarCliente()">Guardar Cliente</button>

<h2>Base de datos de clientes</h2>
<div id="listaClientes"></div>

<hr>

<!-- ================== RUTAS ================== -->
<h2>Crear ruta</h2>

<select id="dia" onchange="cargarRuta()">
<option value="lunes">Lunes</option>
<option value="martes">Martes</option>
<option value="miercoles">Miércoles</option>
<option value="jueves">Jueves</option>
<option value="viernes">Viernes</option>
</select>

<button onclick="borrarRuta()">Borrar ruta del día</button>

<h3>Ruta del día</h3>
<div id="rutaHoy"></div>

<!-- ================== FIREBASE ================== -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE",
  authDomain: "rutas-56f86.firebaseapp.com",
  projectId: "rutas-56f86",
  storageBucket: "rutas-56f86.firebasestorage.app",
  messagingSenderId: "1026881492897",
  appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db=db;
window.collection=collection;
window.addDoc=addDoc;
window.getDocs=getDocs;
window.setDoc=setDoc;
window.doc=doc;
window.deleteDoc=deleteDoc;
window.getDoc=getDoc;

</script>

<!-- ================== LOGICA ================== -->
<script>

let clientesCache=[];
let rutaActual=[];

// -------- GUARDAR CLIENTE --------
async function guardarCliente(){

  const nombre=document.getElementById("nombre").value.trim();
  const localidad=document.getElementById("localidad").value.trim();
  const direccion=document.getElementById("direccion").value.trim();
  const telefono=document.getElementById("telefono").value.trim();

  if(!nombre)return alert("Introduce nombre");

  await addDoc(collection(db,"clientes"),{
    nombre,localidad,direccion,telefono
  });

  document.getElementById("nombre").value="";
  document.getElementById("localidad").value="";
  document.getElementById("direccion").value="";
  document.getElementById("telefono").value="";

  cargarClientes();
}

// -------- CARGAR CLIENTES --------
async function cargarClientes(){

  const cont=document.getElementById("listaClientes");
  cont.innerHTML="Cargando...";

  const snap=await getDocs(collection(db,"clientes"));

  clientesCache=[];
  snap.forEach(d=>clientesCache.push({id:d.id,...d.data()}));

  // ordenar por localidad y nombre
  clientesCache.sort((a,b)=>{
    if(a.localidad===b.localidad)
      return a.nombre.localeCompare(b.nombre);
    return a.localidad.localeCompare(b.localidad);
  });

  cont.innerHTML="";
  let locActual="";

  clientesCache.forEach(c=>{

    if(c.localidad!==locActual){
      locActual=c.localidad;
      cont.innerHTML+=`<div class="localidad">${locActual}</div>`;
    }

    cont.innerHTML+=`
      <div class="cliente">
        <b>${c.nombre}</b> - ${c.direccion}
        <button onclick="añadirARuta('${c.id}')">Añadir</button>
      </div>`;
  });

}

// -------- AÑADIR A RUTA --------
async function añadirARuta(id){

  const dia=document.getElementById("dia").value;
  const ref=doc(db,"rutas",dia);

  const snap=await getDoc(ref);

  let clientes=[];
  if(snap.exists()) clientes=snap.data().clientes||[];

  if(!clientes.includes(id)) clientes.push(id);

  await setDoc(ref,{clientes},{merge:true});

  cargarRuta();
}

// -------- CARGAR RUTA --------
async function cargarRuta(){

  const dia=document.getElementById("dia").value;
  const cont=document.getElementById("rutaHoy");
  cont.innerHTML="Cargando ruta...";

  const snap=await getDoc(doc(db,"rutas",dia));

  if(!snap.exists()){
    cont.innerHTML="No hay ruta";
    return;
  }

  rutaActual=snap.data().clientes||[];

  cont.innerHTML="";

  rutaActual.forEach(id=>{
    const c=clientesCache.find(x=>x.id===id);
    if(c){
      cont.innerHTML+=`<div class="ruta">${c.nombre} - ${c.localidad}</div>`;
    }
  });
}

// -------- BORRAR RUTA --------
async function borrarRuta(){
  const dia=document.getElementById("dia").value;
  await deleteDoc(doc(db,"rutas",dia));
  cargarRuta();
}

// INICIO
window.onload=async()=>{
  await cargarClientes();
  await cargarRuta();
}

</script>

</body>
</html>
