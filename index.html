<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rutas Comerciales PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
    #map { flex:1 }
    #panel { width:350px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
    button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
    button:hover { background:#0284c7 }
    .client { padding:8px; border-bottom:1px solid #ddd }
    .deleteBtn{background:#ef4444;margin-top:6px}
    .deleteBtn:hover{background:#dc2626}
    input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
    small { color:#555 }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Login</h3>
    <input id="email" placeholder="Correo" />
    <input id="password" type="password" placeholder="ContraseÃ±a" />
    <button onclick="login()">ğŸ”‘ Iniciar sesiÃ³n</button>
    <hr>

    <h3>Clientes</h3>
    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="DirecciÃ³n manual (opcional)" />
    <textarea id="notes" placeholder="Notas"></textarea>
    <select id="day">
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="MiÃ©rcoles">MiÃ©rcoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
    </select>

    <button onclick="addClient()">â• Guardar cliente</button>
    <button onclick="calculateRoute()">ğŸ§­ Calcular mejor ruta</button>
    <button onclick="openInGoogleMaps()">ğŸ—º Abrir en Google Maps</button>
    <button onclick="openInWaze()">ğŸš— Abrir en Waze</button>
    <button onclick="exportClients()">ğŸ’¾ Exportar clientes</button>
    <button onclick="importClients()">ğŸ“‚ Importar clientes</button>

    <h3>Filtrar por dÃ­a</h3>
    <select id="filterDay" onchange="render()">
      <option value="Todos">Todos</option>
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="MiÃ©rcoles">MiÃ©rcoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
    </select>

    <h3>EstadÃ­sticas</h3>
    <div id="stats"></div>

    <h3>Listado</h3>
    <div id="clientList"></div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

  // ConfiguraciÃ³n Firebase - reemplaza apiKey y appId con los reales
  const firebaseConfig = {
    apiKey: "TU_API_KEY_REAL",
    authDomain: "rutas-56f86.firebaseapp.com",
    projectId: "rutas-56f86",
    storageBucket: "rutas-56f86.appspot.com",
    messagingSenderId: "1026881492897",
    appId: "TU_APP_ID_REAL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const coleccionClientes = collection(db, "clientes");

  // Login
  async function login() {
    const correo = document.getElementById('email').value;
    const contrasena = document.getElementById('password').value;
    try {
      const userCredential = await signInWithEmailAndPassword(auth, correo, contrasena);
      alert('Login exitoso: ' + userCredential.user.email);
      cargarClientesDesdeFirestore();
    } catch (error) {
      alert('Error al iniciar sesiÃ³n: ' + error.message);
    }
  }

  // Variables globales
  let clients = [];
  let markers = [];
  let routeLine;
  let lastRouteCoords = [];

  // Mapa
  let map = L.map('map').setView([40.4168, -3.7038], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  // Cargar clientes desde Firestore
  async function cargarClientesDesdeFirestore() {
    const snapshot = await getDocs(coleccionClientes);
    clients = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
    render();
  }

  // Agregar cliente
  async function addClient() {
    const name = document.getElementById('name').value;
    const address = document.getElementById('address').value;
    const notes = document.getElementById('notes').value;
    const day = document.getElementById('day').value;
    if(!name) return alert('Pon nombre del cliente');

    let lat, lng;

    if(address){
      const coords = await geocode(address);
      if(!coords) return alert('No se encontrÃ³ direcciÃ³n');
      lat = coords.lat;
      lng = coords.lng;
    } else {
      try {
        const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
      } catch(err){
        return alert('No se pudo obtener tu ubicaciÃ³n');
      }
    }

    await addDoc(coleccionClientes, {name,address,lat,lng,notes,day,visits:0});
    cargarClientesDesdeFirestore();
  }

  // Borrar cliente
  async function deleteClient(id) {
    if(!confirm('Â¿Seguro que quieres borrar este cliente?')) return;
    await deleteDoc(doc(db,"clientes",id));
    cargarClientesDesdeFirestore();
  }

  // Renderizar lista y estadÃ­sticas
  function render(){
    document.getElementById('clientList').innerHTML='';
    document.getElementById('stats').innerHTML='';
    markers.forEach(m=>map.removeLayer(m));
    markers=[];

    const filter = document.getElementById('filterDay').value;
    const filtered = clients.map((c,i)=>({...c,_idx:i})).filter(c=> filter==='Todos' || c.day===filter);

    filtered.forEach(c=>{
      let div=document.createElement('div'); div.className='client';
      div.innerHTML=`
        <input type=checkbox id=c${c._idx}> <b>${c.name}</b><br>
        <small>${c.address|| (c.lat?.toFixed(5)+', '+c.lng?.toFixed(5))}</small><br>
        <small>ğŸ“… ${c.day}</small><br>
        <small>ğŸ“ ${c.notes||''}</small><br>
        <small>Visitas: ${c.visits||0}</small>
        <button class='deleteBtn' onclick='deleteClient("${c.id}")'>ğŸ—‘ï¸ Borrar cliente</button>
      `;
      document.getElementById('clientList').appendChild(div);

      if(c.lat && c.lng){
        let m=L.marker([c.lat,c.lng]).addTo(map).bindPopup(c.name);
        markers.push(m);
      }
    });

    let totalVisits = clients.reduce((sum,c)=>sum+(c.visits||0),0);
    document.getElementById('stats').innerHTML=`Clientes totales: ${clients.length}<br>Total visitas: ${totalVisits}`;
  }

  // GeocodificaciÃ³n
  async function geocode(address){
    let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
    let data = await res.json();
    if(data.length>0) return {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)};
    return null;
  }

  // Calcular ruta (usando OSRM)
  async function calculateRoute(){
    let selected=[];
    clients.forEach((c,i)=>{ if(document.getElementById('c'+i)?.checked) selected.push(c); });
    if(selected.length<1) return alert('Selecciona clientes');

    navigator.geolocation.getCurrentPosition(async pos=>{
      let coords=[[pos.coords.longitude,pos.coords.latitude],...selected.map(c=>[c.lng,c.lat])];
      lastRouteCoords = coords;

      let coordString=coords.map(c=>c.join(',')).join(';');
      let url=`https://router.project-osrm.org/trip/v1/driving/${coordString}?source=first&roundtrip=false&overview=full&geometries=geojson`;
      let res=await fetch(url); let data=await res.json();
      if(routeLine) map.removeLayer(routeLine);
      routeLine=L.geoJSON(data.trips[0].geometry).addTo(map);
      map.fitBounds(routeLine.getBounds());

      selected.forEach(c=>c.visits=(c.visits||0)+1);
      cargarClientesDesdeFirestore(); // guardar visitas actualizadas
    });
  }

  // Abrir en Google Maps
  function openInGoogleMaps(){
    if(lastRouteCoords.length<2) return alert('Calcula ruta primero');
    let origin = lastRouteCoords[0].slice().reverse().join(',');
    let waypoints = lastRouteCoords.slice(1).map(c=>c.slice().reverse().join(',')).join('|');
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&waypoints=${waypoints}`,'_blank');
  }

  // Abrir en Waze
  function openInWaze(){
    if(lastRouteCoords.length<2) return alert('Calcula ruta primero');
    let dest = lastRouteCoords[lastRouteCoords.length-1].slice().reverse().join(',');
    window.open(`https://waze.com/ul?ll=${dest}&navigate=yes`,'_blank');
  }

  // Export / Import JSON
  function exportClients(){
    const dataStr = JSON.stringify(clients, null, 2);
    const blob = new Blob([dataStr], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download='clientes_backup.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importClients(){
    const input = document.createElement('input');
    input.type='file'; input.accept='.json';
    input.onchange=e=>{
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload=()=>{
        try{
          const imported=JSON.parse(reader.result);
          if(Array.isArray(imported)){
            imported.forEach(async c=>{
              await addDoc(coleccionClientes,c);
            });
            cargarClientesDesdeFirestore();
            alert('Clientes importados correctamente');
          } else alert('Archivo no vÃ¡lido');
        } catch(err){ alert('Error leyendo el archivo'); }
      };
      reader.readAsText(file);
    };
    input.click();
  }

</script>
</body>
</html>
