<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family: system-ui, -apple-system, Arial; display:flex; flex-direction: row; height:100vh; background:#f7f7f7; }
#map { flex:1; height: 100%; min-height: 300px; }
#panel { width:380px; padding:16px; overflow-y:auto; background:#f7f7f7; border-left:1px solid #ddd; box-sizing: border-box; }
@media (max-width: 768px) { body { flex-direction: column; } #map { flex: none; height: 40vh; } #panel { width: 100%; flex: 1; border-left: none; border-top: 2px solid #ddd; }}
h3 { margin-top: 20px; color: #333; border-bottom: 2px solid #0ea5e9; padding-bottom: 5px; }
button { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer; font-size: 16px; transition: background 0.2s; }
button:active { background:#0284c7; transform: scale(0.98); }
.client, .routeItem { padding:12px; border-bottom:1px solid #ddd; background: white; margin-bottom: 5px; border-radius: 8px; }
button.smallBtn { padding:4px 8px; font-size:12px; margin-right:4px; display:inline-block; }
.deleteBtn { background:#ef4444; margin-top:0; }
.deleteBtn:active { background:#dc2626; }
input, select, textarea { width:100%; margin:6px 0; padding:12px; border-radius:8px; border:1px solid #ccc; box-sizing: border-box; font-size: 16px; }
hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
small { color:#666; display: block; margin-top: 4px; line-height: 1.4; }
label { font-weight: bold; font-size: 14px; color: #444; }
input[type="checkbox"] { width: auto; transform: scale(1.4); margin-right: 10px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
<h3>Login</h3>
<input id="email" placeholder="Correo" />
<input id="password" type="password" placeholder="ContraseÃ±a" />
<button id="btnLogin">ğŸ”‘ Iniciar sesiÃ³n</button>
<hr>
<h3>Clientes</h3>
<input id="name" placeholder="Nombre cliente" />
<input id="address" placeholder="DirecciÃ³n manual (opcional)" />
<textarea id="notes" placeholder="Notas" rows="2"></textarea>
<input id="lat" placeholder="Latitud (opcional)" />
<input id="lng" placeholder="Longitud (opcional)" />
<button id="btnAddClient">â• Guardar cliente</button>
<hr>
<h3>Rutas</h3>
<label>Fecha de la ruta:</label>
<input type="date" id="routeDate" />
<label>UbicaciÃ³n de salida:</label>
<select id="startOption">
  <option value="gps">ğŸ“ Mi ubicaciÃ³n</option>
  <option value="manual">âœï¸ DirecciÃ³n manual</option>
</select>
<input id="startAddress" placeholder="DirecciÃ³n de salida" style="display:none"/>
<button id="btnCreateRoute">ğŸ§­ Crear nueva ruta</button>
<h4>Rutas guardadas</h4>
<div id="routeList"></div>
<hr>
<button id="btnGoogleMaps" style="background: #34a853;">ğŸ—º Abrir en Google Maps</button>
<button id="btnWaze" style="background: #33ccff;">ğŸš— Abrir en Waze</button>
<button id="btnClearRoute" style="background: #6b7280;">ğŸ§¹ Borrar ruta y marcadores</button>
<h3>EstadÃ­sticas</h3>
<div id="stats" style="font-weight: bold; color: #0ea5e9;"></div>
<h3>Listado de clientes</h3>
<div id="clientList"></div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[];
let editingClientId=null;

// ICONOS
const iconNormal = new L.Icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34]});
const iconFood = new L.Icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/3075/3075977.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-30]});
const iconHotel = new L.Icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/139/139899.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-30]});
const iconPin = new L.Icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/25/25694.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-30]});

function getClientIcon(cliente){
  const text=(cliente.notes||"").toLowerCase();
  if(text.includes("comida")||text.includes("bar")||text.includes("restaurante")) return iconFood;
  if(text.includes("hotel")||text.includes("hostal")) return iconHotel;
  return iconNormal;
}

let map = L.map('map').setView([40.4168,-3.7038],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// --- FUNCIONES PRINCIPALES ---
async function geocode(addr){
  let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  let data = await res.json();
  if(data.length>0) return {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)};
  return null;
}

async function cargarClientes(){
  const snapshot = await getDocs(coleccionClientes);
  clients = snapshot.docs.map(d=>({...d.data(),id:d.id})).filter(c=>c.name);
  clients.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  renderClientes();
}

async function cargarRutas(){
  const snapshot = await getDocs(coleccionRutas);
  const rutas = snapshot.docs.map(d=>({...d.data(),id:d.id}));
  const container = document.getElementById('routeList'); container.innerHTML="";
  rutas.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
  rutas.forEach(r=>{
    let div = document.createElement('div');
    div.className="routeItem";
    div.innerHTML=`${r.date} <button class="smallBtn" onclick="loadRoute('${r.id}')">ğŸŸ¢ Ver</button> <button class="smallBtn" onclick="deleteRoute('${r.id}')">ğŸ—‘ï¸</button>`;
    container.appendChild(div);
  });
}

function renderClientes(){
  const container = document.getElementById('clientList');
  container.innerHTML="";
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  
  clients.forEach((c,i)=>{
    let div = document.createElement('div'); div.className='client';
    div.innerHTML = `<input type=checkbox id=c${i}> <b>${c.name}</b><br><small>${c.address||(c.lat?.toFixed(5)+','+c.lng?.toFixed(5))}</small><br><small>ğŸ“ ${c.notes||''}</small><br>
      <button class="smallBtn" onclick='editClient("${c.id}")'>âœï¸ Editar</button><button class="smallBtn deleteBtn" onclick='deleteClient("${c.id}")'>ğŸ—‘ï¸ Borrar</button>`;
    container.appendChild(div);

    if(c.lat && c.lng){
      let m = L.marker([c.lat, c.lng], {icon: getClientIcon(c)}).addTo(map).bindPopup("<b>"+c.name+"</b><br>"+(c.notes||""));
      m.clientId = c.id;
      m.defaultIcon = getClientIcon(c);

      // --- CLICK PARA SELECCIONAR ---
      m.on('click', () => {
        const checkbox = document.getElementById('c'+i);
        if(checkbox.checked){
          checkbox.checked = false;
          m.setIcon(m.defaultIcon);
        } else {
          checkbox.checked = true;
          m.setIcon(iconPin);
        }
      });

      markers.push(m);
    }
  });
  document.getElementById('stats').innerHTML=`Clientes totales: ${clients.length}`;
}

// --- CRUD y rutas (igual que antes, omitido aquÃ­ por brevedad, se mantiene igual) ---

// Copiar todas tus funciones addClient, deleteClient, createRoute, drawRoute, loadRoute, deleteRoute, openInGoogleMaps, openInWaze, clearRoute, login

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById('btnLogin').addEventListener('click',login);
  document.getElementById('btnAddClient').addEventListener('click',addClient);
  document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
  document.getElementById('btnGoogleMaps').addEventListener('click',window.openInGoogleMaps);
  document.getElementById('btnWaze').addEventListener('click',window.openInWaze);
  document.getElementById('btnClearRoute').addEventListener('click',window.clearRoute);
  document.getElementById('startOption').addEventListener('change', e=>{document.getElementById('startAddress').style.display=e.target.value==="manual"?"block":"none";});
});
</script>
</body>
</html>
