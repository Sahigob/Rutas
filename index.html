<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family: system-ui, -apple-system, Arial; display:flex; flex-direction: row; height:100vh; background:#f7f7f7; }
#map { flex:1; height: 100%; min-height: 300px; }
#panel { width:380px; padding:16px; overflow-y:auto; background:#f7f7f7; border-left:1px solid #ddd; box-sizing: border-box; }
@media (max-width: 768px) { body { flex-direction: column; } #map { flex: none; height: 40vh; } #panel { width: 100%; flex:1; border-left:none; border-top:2px solid #ddd; } }
h3 { margin-top:20px; color:#333; border-bottom:2px solid #0ea5e9; padding-bottom:5px; }
button { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer; font-size:16px; transition:background 0.2s; }
button:active { background:#0284c7; transform:scale(0.98); }
.client, .routeItem { padding:12px; border-bottom:1px solid #ddd; background:white; margin-bottom:5px; border-radius:8px; }
.deleteBtn { background:#ef4444; margin-top:8px; }
.deleteBtn:active { background:#dc2626; }
input, select, textarea { width:100%; margin:6px 0; padding:12px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; font-size:16px; }
hr { border:0; border-top:1px solid #eee; margin:20px 0; }
small { color:#666; display:block; margin-top:4px; line-height:1.4; }
label { font-weight:bold; font-size:14px; color:#444; }
input[type="checkbox"] { width:auto; transform:scale(1.4); margin-right:10px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">

<h3>Login</h3>
<input id="email" placeholder="Correo" />
<input id="password" type="password" placeholder="Contrase√±a" />
<button id="btnLogin">üîë Iniciar sesi√≥n</button>
<hr>

<h3>Clientes / Sitios</h3>
<input id="name" placeholder="Nombre cliente" />
<input id="address" placeholder="Direcci√≥n manual (opcional)" />
<textarea id="notes" placeholder="Notas" rows="2"></textarea>
<input id="lat" placeholder="Latitud (opcional)" />
<input id="lng" placeholder="Longitud (opcional)" />
<label>Tipo:</label>
<select id="type">
  <option value="cliente">Cliente</option>
  <option value="restaurante">Restaurante</option>
  <option value="hotel">Hotel</option>
</select>
<input id="province" placeholder="Provincia (opcional)" />
<button id="btnAddClient">‚ûï Guardar / Actualizar cliente</button>
<hr>

<h3>Filtros</h3>
<label>Tipo:</label>
<select id="filterType">
  <option value="all">Todos</option>
  <option value="cliente">Clientes</option>
  <option value="restaurante">Restaurantes</option>
  <option value="hotel">Hoteles</option>
</select>

<label>Provincias (Ctrl+clic para varias):</label>
<select id="filterProvince" multiple size="5"></select>
<button id="btnApplyFilter">Aplicar filtro</button>
<hr>

<h3>Rutas</h3>
<label>Fecha de la ruta:</label>
<input type="date" id="routeDate" />
<label>Ubicaci√≥n de salida:</label>
<select id="startOption">
  <option value="gps">üìç Mi ubicaci√≥n</option>
  <option value="manual">‚úèÔ∏è Direcci√≥n manual</option>
</select>
<input id="startAddress" placeholder="Direcci√≥n de salida" style="display:none"/>
<button id="btnCreateRoute">üß≠ Crear nueva ruta</button>

<h4>Rutas guardadas</h4>
<div id="routeList"></div>
<hr>

<button id="btnGoogleMaps" style="background:#34a853;">üó∫ Abrir en Google Maps</button>
<button id="btnWaze" style="background:#33ccff;">üöó Abrir en Waze</button>
<button id="btnClearRoute" style="background:#6b7280;">üßπ Borrar ruta y marcadores</button>

<h3>Estad√≠sticas</h3>
<div id="stats" style="font-weight:bold; color:#0ea5e9;"></div>

<h3>Listado de clientes / sitios</h3>
<div id="clientList"></div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE",
  authDomain: "rutas-56f86.firebaseapp.com",
  projectId: "rutas-56f86",
  storageBucket: "rutas-56f86.appspot.com",
  messagingSenderId: "1026881492897",
  appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[];

let map = L.map('map').setView([40.4168,-3.7038],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// --- Login ---
window.login = async function() {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  try {
    const userCredential = await signInWithEmailAndPassword(auth,email,pass);
    alert("Login exitoso: "+userCredential.user.email);
    cargarClientes();
    cargarRutas();
  } catch(err){ alert("Error login: "+err.message); }
};

// --- A√±adir / Modificar Cliente ---
window.addClient = async function(){
  const name = document.getElementById('name').value.trim();
  const address = document.getElementById('address').value.trim();
  const notes = document.getElementById('notes').value.trim();
  const latInput = document.getElementById('lat').value;
  const lngInput = document.getElementById('lng').value;
  const type = document.getElementById('type').value;
  const province = document.getElementById('province').value.trim();

  if(!name) return alert("Pon nombre del cliente");

  let lat,lng;
  if(latInput && lngInput){ lat=parseFloat(latInput); lng=parseFloat(lngInput); }
  else if(address){ const coords = await geocode(address); if(!coords) return alert("No se encontr√≥ direcci√≥n"); lat=coords.lat; lng=coords.lng; }
  else{ try{ const pos = await new Promise((r,j)=> navigator.geolocation.getCurrentPosition(r,j)); lat=pos.coords.latitude; lng=pos.coords.longitude; } catch(err){ return alert("No se pudo obtener ubicaci√≥n"); } }

  // Si existe cliente con mismo nombre -> actualizar
  const existing = clients.find(c=>c.name.toLowerCase()===name.toLowerCase());
  if(existing){
    await updateDoc(doc(db,"clientes",existing.id),{name,address,lat,lng,notes,type,province});
    alert("Cliente actualizado");
  } else {
    await addDoc(coleccionClientes,{name,address,lat,lng,notes,type,province,visits:0});
    alert("Cliente guardado");
  }
  cargarClientes();
};

// --- Borrar Cliente ---
window.deleteClient = async function(id){ if(!confirm("Borrar cliente?")) return; await deleteDoc(doc(db,"clientes",id)); cargarClientes(); };

// --- Mostrar / Dibujar ---
async function cargarClientes(){
  const snapshot = await getDocs(coleccionClientes);
  clients = snapshot.docs.map(d=>({...d.data(),id:d.id})).filter(c=>c.name);
  clients.sort((a,b)=>a.name.localeCompare(b.name));
  actualizarProvinciasSelect();
  renderClientes();
}

function renderClientes(filteredClients){
  const container = document.getElementById('clientList'); container.innerHTML="";
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  const list = filteredClients || clients;
  list.forEach((c,i)=>{
    let div=document.createElement('div'); div.className='client';
    div.innerHTML=`<input type=checkbox id=c${i}> <b>${c.name}</b> [${c.type}]<br>
      <small>${c.address|| (c.lat?.toFixed(5)+','+c.lng?.toFixed(5))}</small><br>
      <small>üìù ${c.notes||''}</small><br>
      <small>üìç ${c.province||''}</small><br>
      <button class='deleteBtn' onclick='deleteClient("${c.id}")'>üóëÔ∏è Borrar</button>`;
    container.appendChild(div);

    let iconColor = "blue";
    if(c.type==="restaurante") iconColor="green";
    if(c.type==="hotel") iconColor="orange";
    if(c.lat && c.lng){ 
      let m = L.circleMarker([c.lat,c.lng],{radius:8,color:iconColor,fillColor:iconColor,fillOpacity:0.6}).addTo(map).bindPopup(c.name+" ["+c.type+"]");
      markers.push(m); 
    }
  });
  document.getElementById('stats').innerHTML=`Total: ${list.length}`;
}

// --- Filtrar por tipo / provincia ---
function actualizarProvinciasSelect(){
  const select = document.getElementById('filterProvince');
  select.innerHTML="";
  const provincias = [...new Set(clients.map(c=>c.province).filter(p=>p))].sort();
  provincias.forEach(p=>{
    let opt=document.createElement('option'); opt.value=p; opt.textContent=p; select.appendChild(opt);
  });
}

document.getElementById('btnApplyFilter').addEventListener('click',()=>{
  const type = document.getElementById('filterType').value;
  const provinceSelect = document.getElementById('filterProvince');
  const selectedProvinces = Array.from(provinceSelect.selectedOptions).map(o=>o.value);
  let filtered = clients;
  if(type!=="all") filtered = filtered.filter(c=>c.type===type);
  if(selectedProvinces.length>0) filtered = filtered.filter(c=>selectedProvinces.includes(c.province));
  renderClientes(filtered);
});

// --- Rutas y OSRM ---
document.getElementById('startOption').addEventListener('change',e=>{ document.getElementById('startAddress').style.display=e.target.value==="manual"?"block":"none"; });

window.createRoute = async function(){
  let selectedClients = clients.filter((c,i)=>document.getElementById('c'+i)?.checked);
  if(selectedClients.length<1) return alert("Selecciona clientes");
  let startOption = document.getElementById('startOption').value;
  let startLat,startLng;
  if(startOption==="gps"){ try{ const pos = await new Promise((r,j)=> navigator.geolocation.getCurrentPosition(r,j)); startLat=pos.coords.latitude; startLng=pos.coords.longitude; }catch(err){ return alert("No se pudo obtener ubicaci√≥n"); } }
  else{
    let addr = document.getElementById('startAddress').value.trim();
    if(!addr) return alert("Introduce direcci√≥n de salida");
    const coords = await geocode(addr); if(!coords) return alert("Direcci√≥n no v√°lida");
    startLat=coords.lat; startLng=coords.lng;
  }
  const date = document.getElementById('routeDate').value;
  if(!date) return alert("Elige fecha de la ruta");
  let coords=[[startLat,startLng], ...selectedClients.map(c=>[c.lat,c.lng])];
  lastRouteCoords = coords;
  await addDoc(coleccionRutas,{date,clients:selectedClients.map(c=>c.id),start:{lat:startLat,lng:startLng}});
  alert("Ruta guardada");
  cargarRutas();
  drawRoute(coords);
};

function drawRoute(coords){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
  const coordStr = coords.map(c=>c[1]+","+c[0]).join(";");
  fetch(`https://router.project-osrm.org/trip/v1/driving/${coordStr}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r=>r.json())
    .then(data=>{
      routeLine=L.geoJSON(data.trips[0].geometry).addTo(map);
      map.fitBounds(routeLine.getBounds());
      coords.slice(1).forEach(c=>{ let m=L.circleMarker(c,{radius:8,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map); redMarkers.push(m); });
    });
}

async function cargarRutas(){
  const snapshot = await getDocs(coleccionRutas);
  const rutas = snapshot.docs.map(d=>({...d.data(),id:d.id}));
  const container = document.getElementById('routeList'); container.innerHTML="";
  rutas.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  rutas.forEach(r=>{
    let div = document.createElement('div'); div.className="routeItem";
    div.innerHTML=`${r.date} <button onclick="loadRoute('${r.id}')" style="width:auto;padding:5px 10px;margin-left:10px">üü¢ Ver</button> <button onclick="deleteRoute('${r.id}')" style="width:auto;padding:5px 10px;background:#666">üóëÔ∏è</button>`;
    container.appendChild(div);
  });
}

window.loadRoute = async function(id){
  const snapshot = await getDocs(coleccionRutas);
  const routeDoc = snapshot.docs.find(d=>d.id===id);
  if(!routeDoc) return alert("Ruta no encontrada");
  const data = routeDoc.data();
  const selectedClients = clients.filter(c=>data.clients.includes(c.id));
  let coords=[[data.start.lat,data.start.lng], ...selectedClients.map(c=>[c.lat,c.lng])];
  lastRouteCoords = coords;
  drawRoute(coords);
};

window.deleteRoute = async function(id){ if(!confirm("Borrar ruta?")) return; await deleteDoc(doc(db,"rutas",id)); cargarRutas(); };

window.openInGoogleMaps = function(){
  if(lastRouteCoords.length<2) return alert("Calcula ruta primero");
  let origin=lastRouteCoords[0].join(',');
  let waypoints=lastRouteCoords.slice(1).map(c=>c.join('|')).join('|');
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${lastRouteCoords[lastRouteCoords.length-1].join(',')}&waypoints=${waypoints}`,'_blank');
};
window.openInWaze = function(){
  if(lastRouteCoords.length<2) return alert("Calcula ruta primero");
  let dest=lastRouteCoords[lastRouteCoords.length-1].join(',');
  window.open(`https://waze.com/ul?ll=${dest}&navigate=yes`,'_blank');
};
window.clearRoute = function(){ if(routeLine) map.removeLayer(routeLine); routeLine=null; redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[]; lastRouteCoords=[]; };

// --- Geocode ---
async function geocode(addr){
  let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  let data = await res.json();
  if(data.length>0) return {lat:parseFloat(data[0].lat),lng:parseFloat(data[0].lon)};
  return null;
}

// --- Event listeners ---
document.getElementById('btnLogin').addEventListener('click',login);
document.getElementById('btnAddClient').addEventListener('click',addClient);
document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
document.getElementById('btnGoogleMaps').addEventListener('click',window.openInGoogleMaps);
document.getElementById('btnWaze').addEventListener('click',window.openInWaze);
document.getElementById('btnClearRoute').addEventListener('click',window.clearRoute);

</script>
</body>
</html>
