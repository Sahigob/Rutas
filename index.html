<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO - Local</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
  #map { flex:1 }
  #panel { width:400px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
  button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
  button:hover { background:#0284c7 }
  .deleteBtn{background:#ef4444;margin-top:6px}
  .deleteBtn:hover{background:#dc2626}
  input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
  small { color:#555 }
  h4 { margin:10px 0 4px 0 }
</style>
</head>
<body>

<div id="map"></div>
<div id="panel">
  <h3>Clientes</h3>
  <input id="name" placeholder="Nombre cliente" />
  <input id="address" placeholder="DirecciÃ³n manual (opcional)" />
  <textarea id="notes" placeholder="Notas"></textarea>
  <input id="lat" placeholder="Latitud (opcional)" />
  <input id="lng" placeholder="Longitud (opcional)" />
  <button id="btnAddClient">â• Guardar cliente</button>
  <hr>

  <h3>Rutas</h3>
  <input type="date" id="routeDate" />
  <button id="btnCreateRoute">ğŸ§­ Crear nueva ruta</button>
  <h4>Rutas guardadas</h4>
  <div id="savedRoutes"></div>
  <button id="btnClearRoute">ğŸ§¹ Borrar ruta actual</button>
  <hr>

  <h3>Export / Import</h3>
  <button id="btnExport">ğŸ’¾ Exportar clientes y rutas</button>
  <button id="btnImport">ğŸ“‚ Importar clientes y rutas</button>

  <h3>Listado de Clientes</h3>
  <div id="clientList"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// === Variables globales ===
let clients = JSON.parse(localStorage.getItem('clients')||'[]');
let routes = JSON.parse(localStorage.getItem('routes')||'{}');
let markers = [];
let redMarkers = [];
let routeLine;
let map = L.map('map').setView([40.4168, -3.7038], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// === Funciones ===
function saveClients() { localStorage.setItem('clients', JSON.stringify(clients)); }
function saveRoutes() { localStorage.setItem('routes', JSON.stringify(routes)); }

async function geocode(address){
  if(!address) return null;
  let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
  let data = await res.json();
  if(data.length>0) return {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)};
  return null;
}

function renderClients(){
  const div = document.getElementById('clientList');
  div.innerHTML='';
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  clients.forEach((c,i)=>{
    let cdiv=document.createElement('div');
    cdiv.className='client';
    cdiv.innerHTML=`<input type="checkbox" id="c${i}"> <b>${c.name}</b><br>
      <small>${c.address|| (c.lat?.toFixed(5)+', '+c.lng?.toFixed(5))}</small><br>
      <small>ğŸ“ ${c.notes||''}</small><br>
      <button class='deleteBtn' onclick='deleteClient(${i})'>ğŸ—‘ï¸ Borrar cliente</button>`;
    div.appendChild(cdiv);
    if(c.lat && c.lng){
      let m = L.marker([c.lat,c.lng]).addTo(map).bindPopup(c.name);
      markers.push(m);
    }
  });
}

function renderSavedRoutes(){
  const div = document.getElementById('savedRoutes');
  div.innerHTML='';
  Object.keys(routes).sort().forEach(date=>{
    let btn = document.createElement('button');
    btn.textContent=date;
    btn.onclick=()=>loadRoute(date);
    div.appendChild(btn);
    let del = document.createElement('button');
    del.textContent='ğŸ—‘ï¸';
    del.style.width='30px';
    del.style.margin='0 0 6px 6px';
    del.onclick=(e)=>{ e.stopPropagation(); deleteRoute(date); };
    div.appendChild(del);
    div.appendChild(document.createElement('br'));
  });
}

async function addClient(){
  const name=document.getElementById('name').value.trim();
  if(!name){ alert('Pon nombre'); return; }
  const address=document.getElementById('address').value.trim();
  const notes=document.getElementById('notes').value.trim();
  const latInput=document.getElementById('lat').value.trim();
  const lngInput=document.getElementById('lng').value.trim();
  let lat,lng;
  if(latInput && lngInput){
    lat=parseFloat(latInput); lng=parseFloat(lngInput);
  } else if(address){
    const coords = await geocode(address);
    if(!coords) { alert('No se encontrÃ³ direcciÃ³n'); return; }
    lat=coords.lat; lng=coords.lng;
  } else {
    try{
      const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
      lat=pos.coords.latitude; lng=pos.coords.longitude;
    } catch(err){
      alert('No se pudo obtener ubicaciÃ³n'); return;
    }
  }
  clients.push({name,address,notes,lat,lng});
  saveClients();
  renderClients();
  document.getElementById('name').value='';
  document.getElementById('address').value='';
  document.getElementById('notes').value='';
  document.getElementById('lat').value='';
  document.getElementById('lng').value='';
}

function deleteClient(i){ if(confirm('Borrar cliente?')){ clients.splice(i,1); saveClients(); renderClients(); } }

async function createRoute(){
  const date = document.getElementById('routeDate').value;
  if(!date){ alert('Selecciona fecha'); return; }
  let originOption = prompt('Origen: escribe "actual" para tu ubicaciÃ³n o una direcciÃ³n manual:','actual');
  let originCoords;
  if(originOption.toLowerCase()==='actual'){
    try{
      const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve,reject));
      originCoords=[pos.coords.latitude,pos.coords.longitude];
    } catch(err){ alert('No se pudo obtener ubicaciÃ³n'); return; }
  } else {
    const coords = await geocode(originOption);
    if(!coords){ alert('No se encontrÃ³ la direcciÃ³n'); return; }
    originCoords=[coords.lat,coords.lng];
  }
  // Seleccionar clientes
  let selectedClients = clients.filter((c,i)=>document.getElementById('c'+i)?.checked);
  if(selectedClients.length<1){ alert('Selecciona clientes para la ruta'); return; }

  let coords = [originCoords,...selectedClients.map(c=>[c.lat,c.lng])];
  let coordString = coords.map(c=>c.reverse().join(',')).join(';'); // lon,lat para OSRM
  let url = `https://router.project-osrm.org/trip/v1/driving/${coordString}?source=first&roundtrip=false&overview=full&geometries=geojson`;
  let res = await fetch(url); let data = await res.json();
  let geo = data.trips[0].geometry;

  // Guardar ruta
  routes[date]={clients:selectedClients.map(c=>c.name),geo};
  saveRoutes();
  renderSavedRoutes();
  drawRoute(geo);
}

function drawRoute(geo){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
  routeLine=L.geoJSON(geo).addTo(map);
  map.fitBounds(routeLine.getBounds());
  // marcar clientes en rojo
  let coords = routeLine.getLayers()[0].getLatLngs();
  coords.forEach(c=>{
    let m = L.circleMarker(c,{radius:6,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map);
    redMarkers.push(m);
  });
}

function loadRoute(date){
  let r = routes[date];
  if(!r) return;
  drawRoute(r.geo);
}

function deleteRoute(date){
  if(confirm('Borrar esta ruta?')){ delete routes[date]; saveRoutes(); renderSavedRoutes(); if(routeLine){ map.removeLayer(routeLine); routeLine=null; } }
}

// Export/Import
function exportData(){
  const data = {clients,routes};
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

function importData(){
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=e=>{
    const file=input.files[0];
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const data=JSON.parse(reader.result);
        if(data.clients) clients=data.clients;
        if(data.routes) routes=data.routes;
        saveClients(); saveRoutes(); renderClients(); renderSavedRoutes();
        alert('ImportaciÃ³n completada');
      } catch(err){ alert('Error leyendo archivo'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

// === Event listeners ===
document.getElementById('btnAddClient').addEventListener('click',addClient);
document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
document.getElementById('btnClearRoute').addEventListener('click',()=>{ if(routeLine){ map.removeLayer(routeLine); routeLine=null; } redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[]; });
document.getElementById('btnExport').addEventListener('click',exportData);
document.getElementById('btnImport').addEventListener('click',importData);

// Inicializar
renderClients();
renderSavedRoutes();
</script>
</body>
</html>
