<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas PRO - Verificador OSM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    body { margin:0; font-family: sans-serif; display:flex; height:100vh; background: #f0f2f5; }
    #map { flex:1; }
    #panel { width:400px; padding:20px; overflow-y:auto; background: white; border-left: 2px solid #ddd; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    button { width:100%; padding:12px; margin:5px 0; border-radius:6px; border:none; cursor:pointer; font-weight:bold; color: white; }
    #btnOSM { background: #0ea5e9; }
    #btnGoogle { background: #ffc107; color: #000; }
    .debug-list { background: #222; color: #0f0; font-family: monospace; padding: 10px; font-size: 11px; border-radius: 5px; max-height: 150px; overflow-y: auto; }
    .client-item { padding: 5px; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <div class="card">
        <h3>1. Configuraci贸n</h3>
        <button id="btnOSM">Л Calcular Ruta OSM</button>
    </div>

    <div class="card">
        <h3>2. Verificaci贸n del Motor</h3>
        <p style="font-size: 12px; color: #666;">Este es el orden exacto que calcul贸 OpenStreetMap:</p>
        <div id="debugOrder" class="debug-list">Esperando ruta...</div>
    </div>

    <div class="card">
        <h3>3. Navegaci贸n</h3>
        <button id="btnGoogle"> Abrir en Google (Orden de arriba)</button>
    </div>

    <div id="clientList" class="card"><h4>Clientes</h4></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let clients = [], lastRouteCoords = [];
let map = L.map('map').setView([40.4168, -3.7038], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Cargar clientes
const snap = await getDocs(collection(db, "clientes"));
clients = snap.docs.map(d => ({...d.data(), id: d.id})).filter(c => c.lat);
clients.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'client-item';
    div.innerHTML = `<input type="checkbox" class="c-check" data-idx="${i}"> ${c.name}`;
    document.getElementById('clientList').appendChild(div);
    L.marker([c.lat, c.lng]).addTo(map).bindPopup(c.name);
});

// CALCULAR RUTA CON OSM
document.getElementById('btnOSM').onclick = async () => {
    let sel = [];
    document.querySelectorAll('.c-check:checked').forEach(cb => {
        sel.push(clients[cb.dataset.idx]);
    });

    if (sel.length === 0) return alert("Selecciona clientes");

    // Inicio Madrid (puedes cambiarlo a GPS)
    const inicio = [40.4168, -3.7038]; 
    const pts = [inicio, ...sel.map(c => [c.lat, c.lng])];
    const strPts = pts.map(p => `${p[1]},${p[0]}`).join(';');

    // Llamada a OSRM (Motor OpenStreetMap)
    const res = await fetch(`https://router.project-osrm.org/trip/v1/driving/${strPts}?source=first&destination=last&roundtrip=false&overview=full&geometries=geojson`);
    const data = await res.json();

    if (data.waypoints) {
        // OSRM a veces reordena para que el viaje sea l贸gico. 
        // Extraemos el orden REAL que decidi贸 OSM:
        lastRouteCoords = data.waypoints
            .sort((a, b) => a.waypoint_index - b.waypoint_index)
            .map(w => [w.location[1], w.location[0]]);

        // Mostrar el orden en el panel de debug
        const debugDiv = document.getElementById('debugOrder');
        debugDiv.innerHTML = lastRouteCoords.map((c, i) => {
            return `${i === 0 ? 'SALIDA' : 'PARADA ' + i}: ${c[0].toFixed(4)}, ${c[1].toFixed(4)}`;
        }).join('<br>');

        // Dibujar en mapa
        if(window.currentPath) map.removeLayer(window.currentPath);
        window.currentPath = L.geoJSON(data.trips[0].geometry, {style: {color: '#0ea5e9', weight: 6}}).addTo(map);
        map.fitBounds(window.currentPath.getBounds());
    }
};

// ENVIAR A GOOGLE
document.getElementById('btnGoogle').onclick = () => {
    if (lastRouteCoords.length < 2) return alert("Primero calcula la ruta con el bot贸n azul");

    const origin = `${lastRouteCoords[0][0]},${lastRouteCoords[0][1]}`;
    const destination = `${lastRouteCoords[lastRouteCoords.length - 1][0]},${lastRouteCoords[lastRouteCoords.length - 1][1]}`;
    
    // Aqu铆 est谩 el truco: usamos los puntos intermedios que OSM dijo que eran mejores
    let waypoints = "";
    if (lastRouteCoords.length > 2) {
        waypoints = lastRouteCoords.slice(1, -1).map(c => `${c[0]},${c[1]}`).join('|');
    }

    // URL Estricta: Obligamos a Google a usar el orden de los waypoints de OSM
    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${encodeURIComponent(waypoints)}&travelmode=driving`;
    
    window.open(url, '_blank');
};
</script>
</body>
</html>
