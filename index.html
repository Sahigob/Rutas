<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root {
  --primary: #0ea5e9;
  --primary-dark: #0284c7;
  --bg: #f8fafc;
  --card-bg: #ffffff;
  --text: #1e293b;
  --border: #e2e8f0;
}

body { margin:0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; display:flex; flex-direction: row; height:100vh; background: var(--bg); color: var(--text); }

#map { flex:1; height: 100%; z-index: 1; }

#panel { 
  width:400px; 
  padding:24px; 
  overflow-y:auto; 
  background: var(--card-bg); 
  border-left: 1px solid var(--border); 
  box-sizing: border-box; 
  box-shadow: -4px 0 15px rgba(0,0,0,0.05);
  z-index: 10;
}

@media (max-width: 768px) { 
  body { flex-direction: column; } 
  #map { flex: none; height: 40vh; } 
  #panel { width: 100%; flex: 1; border-left: none; border-top: 2px solid var(--border); }
}

h3 { 
  margin: 24px 0 12px 0; 
  font-size: 1.1rem; 
  font-weight: 700; 
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

h3::before {
  content: '';
  width: 4px;
  height: 18px;
  background: var(--primary);
  border-radius: 4px;
}

.card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  transition: box-shadow 0.2s;
}

button { 
  width:100%; 
  padding:12px; 
  margin:8px 0; 
  border-radius:10px; 
  border:none; 
  background: var(--primary); 
  color:white; 
  font-weight:600; 
  cursor:pointer; 
  font-size: 14px; 
  transition: all 0.2s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}

button:hover { background: var(--primary-dark); }
button:active { transform: scale(0.98); }

.smallBtn { padding:6px 12px; font-size:12px; margin: 4px 2px; width: auto; display: inline-flex; }
.deleteBtn { background:#ef4444; }
.deleteBtn:hover { background:#dc2626; }

input, select, textarea { 
  width:100%; 
  margin:8px 0; 
  padding:12px; 
  border-radius:10px; 
  border:1px solid var(--border); 
  box-sizing: border-box; 
  font-size: 14px; 
  background: #fdfdfd;
}

.client { 
  padding:12px; 
  border: 1px solid var(--border); 
  background: white; 
  margin-bottom: 8px; 
  border-radius: 10px;
}

.stats-badge {
  background: #e0f2fe;
  color: #0369a1;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
}

label { font-weight: 600; font-size: 13px; margin-bottom: 4px; display: block; }
input[type="checkbox"] { width: auto; transform: scale(1.2); margin-right: 12px; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <div class="card">
    <h3>üîê Login</h3>
    <input id="email" placeholder="Correo electr√≥nico" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Iniciar sesi√≥n</button>
  </div>

  <div class="card">
    <h3>üë• Clientes</h3>
    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="Direcci√≥n manual" />
    <textarea id="notes" placeholder="Notas" rows="2"></textarea>
    <div style="display:flex; gap:8px">
        <input id="lat" placeholder="Latitud" />
        <input id="lng" placeholder="Longitud" />
    </div>
    <button id="btnAddClient">‚ûï Guardar cliente</button>
  </div>

  <div class="card">
    <h3>üß≠ Rutas</h3>
    <label>Fecha de la ruta:</label>
    <input type="date" id="routeDate" />
    <label>Ubicaci√≥n de salida:</label>
    <select id="startOption">
      <option value="gps">üìç Mi ubicaci√≥n actual</option>
      <option value="manual">‚úèÔ∏è Direcci√≥n manual</option>
    </select>
    <input id="startAddress" placeholder="Direcci√≥n de salida" style="display:none"/>
    <button id="btnCreateRoute">üß≠ Crear nueva ruta</button>
    <h4 style="margin:16px 0 8px 0; font-size:0.9rem">Rutas guardadas</h4>
    <div id="routeList"></div>
  </div>

  <div class="card">
    <h3>üöÄ Navegaci√≥n</h3>
    <button id="btnGoogleMaps" style="background: #22c55e;">üåê Google Maps</button>
    <button id="btnWaze" style="background: #33ccff;">üöô Waze</button>
    <button id="btnClearRoute" style="background: #64748b;">üßπ Limpiar mapa</button>
  </div>

  <h3>üìä Estad√≠sticas <span id="stats" class="stats-badge">0</span></h3>
  <div id="clientList"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[], lastRouteClients=[];
let editingClientId = null;
let currentStartOption = "gps"; // Rastreamos el modo de inicio actual

const iconNormal = new L.Icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34] });
const iconFood = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/3448/3448609.png", iconSize:[38,38], iconAnchor:[19,38], popupAnchor:[0,-34] });
const iconHotel = new L.Icon({ iconUrl: "data:image/svg+xml;base64," + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 38 38"><circle cx="19" cy="19" r="18" fill="#ff9900" stroke="white" stroke-width="2"/><text x="50%" y="55%" font-size="18" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold">H</text></svg>`), iconSize:[38,38], iconAnchor:[19,38], popupAnchor:[0,-34] });
const iconPin = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-30] });

function getClientIcon(cliente){
  const text=(cliente.notes||"").toLowerCase();
  if(text.includes("comida")||text.includes("bar")||text.includes("restaurante")) return iconFood;
  if(text.includes("hotel")||text.includes("hostal")) return iconHotel;
  return iconNormal;
}

let map = L.map('map').setView([40.4168,-3.7038],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

async function geocode(addr){ let res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`); let data=await res.json(); if(data.length>0) return {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)}; return null; }

async function cargarClientes(){ const snapshot=await getDocs(coleccionClientes); clients=snapshot.docs.map(d=>({...d.data(),id:d.id})).filter(c=>c.name); clients.sort((a,b)=>(a.name||"").localeCompare(b.name||"")); renderClientes(); }

async function cargarRutas(){ const snapshot=await getDocs(coleccionRutas); const rutas=snapshot.docs.map(d=>({...d.data(),id:d.id})); const container=document.getElementById('routeList'); container.innerHTML=""; rutas.sort((a,b)=>(a.date||'').localeCompare(b.date||'')); rutas.forEach(r=>{ let div=document.createElement('div'); div.className="routeItem"; div.innerHTML=`${r.date} <button class="smallBtn" onclick="loadRoute('${r.id}')">üü¢ Ver</button> <button class="smallBtn" onclick="deleteRoute('${r.id}')">üóëÔ∏è</button>`; container.appendChild(div); }); }

function renderClientes(){ const container=document.getElementById('clientList'); container.innerHTML=""; markers.forEach(m=>map.removeLayer(m)); markers=[]; clients.forEach((c,i)=>{ let div=document.createElement('div'); div.className='client'; div.innerHTML=`<input type=checkbox id=c${i}> <b>${c.name}</b><br><small>${c.address||(c.lat?.toFixed(5)+','+c.lng?.toFixed(5))}</small><br><small>üìù ${c.notes||''}</small><br><button class="smallBtn" onclick='editClient("${c.id}")'>‚úèÔ∏è Editar</button><button class="smallBtn deleteBtn" onclick='deleteClient("${c.id}")'>üóëÔ∏è Borrar</button>`; container.appendChild(div); if(c.lat&&c.lng){ let m=L.marker([c.lat,c.lng],{icon:getClientIcon(c)}).addTo(map).bindPopup("<b>"+c.name+"</b><br>"+(c.notes||"")); m.clientId=c.id; m.defaultIcon=getClientIcon(c); m.on('click',()=>{ const checkbox=document.getElementById('c'+i); checkbox.checked=!checkbox.checked; m.setIcon(checkbox.checked?iconPin:m.defaultIcon); }); const checkbox=document.getElementById('c'+i); checkbox.addEventListener('change',()=>{ m.setIcon(checkbox.checked?iconPin:m.defaultIcon); }); markers.push(m); } }); document.getElementById('stats').innerHTML=clients.length; }

window.editClient=function(id){ const c=clients.find(x=>x.id===id); if(!c) return; editingClientId=id; document.getElementById('name').value=c.name||''; document.getElementById('address').value=c.address||''; document.getElementById('notes').value=c.notes||''; document.getElementById('lat').value=c.lat||''; document.getElementById('lng').value=c.lng||''; document.getElementById('btnAddClient').textContent='üíæ Guardar cambios'; window.scrollTo({top:0,behavior:'smooth'}); }
window.deleteClient=async function(id){ if(!confirm("Borrar cliente?")) return; await deleteDoc(doc(db,"clientes",id)); cargarClientes(); };

window.addClient=async function(){ 
    const nEl=document.getElementById('name'), aEl=document.getElementById('address'), noEl=document.getElementById('notes'), laEl=document.getElementById('lat'), lnEl=document.getElementById('lng'), btn=document.getElementById('btnAddClient');
    const name=nEl.value.trim(), address=aEl.value.trim(), notes=noEl.value.trim(), latIn=laEl.value, lngIn=lnEl.value;
    if(!name) return alert("Pon nombre");
    let lat, lng;
    if(latIn && lngIn){ lat=parseFloat(latIn); lng=parseFloat(lnIn); }
    else if(address){ const co=await geocode(address); if(!co) return alert("No encontrada"); lat=co.lat; lng=co.lng; }
    else { try { const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j)); lat=pos.coords.latitude; lng=pos.coords.longitude; } catch(e){ return alert("Error GPS"); } }
    if(editingClientId){ await updateDoc(doc(db,"clientes",editingClientId),{name,address,lat,lng,notes}); editingClientId=null; btn.textContent='‚ûï Guardar cliente'; alert("‚úÖ Cambios guardados"); }
    else { await addDoc(coleccionClientes,{name,address,lat,lng,notes,visits:0}); alert("‚úÖ Cliente guardado"); }
    nEl.value=""; aEl.value=""; noEl.value=""; laEl.value=""; lnEl.value=""; cargarClientes();
}

window.createRoute=async function(){ 
    let sel=clients.filter((c,i)=>document.getElementById('c'+i)?.checked); 
    if(sel.length<1) return alert("Selecciona clientes"); 
    currentStartOption = document.getElementById('startOption').value;
    let sLat, sLng;
    if(currentStartOption==="gps"){ try { const p=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j)); sLat=p.coords.latitude; sLng=p.coords.longitude; } catch(e){ return alert("GPS error"); } }
    else { let ad=document.getElementById('startAddress').value.trim(); if(!ad) return alert("Direcci√≥n salida vac√≠a"); const c=await geocode(ad); if(!c) return alert("No v√°lida"); sLat=c.lat; sLng=c.lng; }
    const date=document.getElementById('routeDate').value; 
    if(!date) return alert("Elige fecha");
    lastRouteCoords=[[sLat,sLng],...sel.map(c=>[c.lat,c.lng])];
    lastRouteClients=sel;
    // IMPORTANTE: Guardamos el modo (gps o manual) para la navegaci√≥n posterior
    await addDoc(coleccionRutas,{date,clients:sel.map(c=>c.id),start:{lat:sLat,lng:sLng}, mode: currentStartOption});
    alert("Ruta guardada"); cargarRutas(); drawRoute(lastRouteCoords);
}

function drawRoute(coords){ 
    if(routeLine) map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
    const str=coords.map(c=>c[1]+","+c[0]).join(";");
    fetch(`https://router.project-osrm.org/trip/v1/driving/${str}?source=first&roundtrip=false&overview=full&geometries=geojson`).then(r=>r.json()).then(d=>{
        routeLine=L.geoJSON(d.trips[0].geometry).addTo(map); map.fitBounds(routeLine.getBounds());
        coords.slice(1).forEach(c=>{ let m=L.circleMarker(c,{radius:8,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map); redMarkers.push(m); });
    });
}

window.loadRoute=async function(id){ 
    const sn=await getDocs(coleccionRutas); const rd=sn.docs.find(d=>d.id===id); if(!rd)return;
    const d=rd.data(); 
    currentStartOption = d.mode || "manual"; // Recuperamos si era GPS o manual
    lastRouteClients=clients.filter(c=>d.clients.includes(c.id));
    lastRouteCoords=[[d.start.lat,d.start.lng],...lastRouteClients.map(c=>[c.lat,c.lng])];
    drawRoute(lastRouteCoords);
}

window.deleteRoute=async function(id){ if(confirm("Borrar?")) { await deleteDoc(doc(db,"rutas",id)); cargarRutas(); } }

// --- FUNCI√ìN CORREGIDA PARA UBICACI√ìN REAL ---
window.openInGoogleMaps=function(){ 
    if(lastRouteCoords.length<2) return alert("Calcula ruta primero"); 
    
    // Si elegiste GPS, dejamos el origen vac√≠o para que Google Maps use tu ubicaci√≥n REAL en vivo.
    // Si elegiste Manual, usamos las coordenadas que marcaste.
    let origin = (currentStartOption === "gps") ? "" : lastRouteCoords[0].join(',');
    
    let lastClient = lastRouteClients[lastRouteClients.length - 1];
    let destination = lastClient.address ? encodeURIComponent(lastClient.address) : lastRouteCoords[lastRouteCoords.length-1].join(',');
    
    let waypoints = "";
    if(lastRouteClients.length > 1) {
        waypoints = lastRouteClients.slice(0, -1).map(c => c.address ? encodeURIComponent(c.address) : (c.lat + ',' + c.lng)).join('|');
    }

    let url=`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
    if(waypoints) url += `&waypoints=${waypoints}`;
    url += `&travelmode=driving`;
    
    window.open(url,'_blank'); 
}

window.openInWaze=function(){ 
    if(lastRouteCoords.length<2) return alert("Calcula ruta primero"); 
    let dest=lastRouteCoords[lastRouteCoords.length-1].join(','); 
    window.open(`https://waze.com/ul?ll=${dest}&navigate=yes`,'_blank'); 
}

window.clearRoute=function(){ if(routeLine) map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[]; lastRouteCoords=[]; lastRouteClients=[]; }

window.login=async function(){ 
    const e=document.getElementById('email').value, p=document.getElementById('password').value;
    try { await signInWithEmailAndPassword(auth,e,p); alert("Login OK"); cargarClientes(); cargarRutas(); } catch(e){ alert("Error: "+e.message); }
}

document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById('btnLogin').addEventListener('click',login);
    document.getElementById('btnAddClient').addEventListener('click',addClient);
    document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
    document.getElementById('btnGoogleMaps').addEventListener('click',window.openInGoogleMaps);
    document.getElementById('btnWaze').addEventListener('click',window.openInWaze);
    document.getElementById('btnClearRoute').addEventListener('click',window.clearRoute);
    document.getElementById('startOption').addEventListener('change',e=>{ document.getElementById('startAddress').style.display=(e.target.value==="manual")?"block":"none"; });
    cargarClientes(); cargarRutas();
});
</script>
</body>
</html>
