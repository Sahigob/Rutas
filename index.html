window.createRoute=async function(){ 
    let sel=clients.filter((c,i)=>document.getElementById('c'+i)?.checked); 
    if(sel.length<1) return alert("Selecciona clientes"); 
    currentStartOption = document.getElementById('startOption').value;
    let sLat, sLng;
    if(currentStartOption==="gps"){ try { const p=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j)); sLat=p.coords.latitude; sLng=p.coords.longitude; } catch(e){ return alert("GPS error"); } }
    else { let ad=document.getElementById('startAddress').value.trim(); if(!ad) return alert("Salida vacÃ­a"); const c=await geocode(ad); if(!c) return alert("No vÃ¡lida"); sLat=c.lat; sLng=c.lng; }
    lastRouteCoords=[[sLat,sLng],...sel.map(c=>[c.lat,c.lng])];
    lastRouteClients=sel;
    await addDoc(coleccionRutas,{date:document.getElementById('routeDate').value, clients:sel.map(c=>c.id), start:{lat:sLat,lng:sLng}, mode:currentStartOption});
    cargarRutas();
    drawRoute(lastRouteCoords);
}

function drawRoute(coords){ 
    if(routeLine) map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
    const str=coords.map(c=>c[1]+","+c[0]).join(";");
    fetch(`https://router.project-osrm.org/trip/v1/driving/${str}?source=first&roundtrip=false&overview=full&geometries=geojson`).then(r=>r.json()).then(d=>{
        if(!d.trips) return;
        routeLine=L.geoJSON(d.trips[0].geometry,{style:{color:'#0ea5e9',weight:5}}).addTo(map); map.fitBounds(routeLine.getBounds());
        coords.slice(1).forEach(c=>{ redMarkers.push(L.circleMarker(c,{radius:6,color:'red',fillOpacity:1}).addTo(map)); });
    });
}

window.loadRoute=async function(id){ 
    const sn=await getDocs(coleccionRutas); const rd=sn.docs.find(d=>d.id===id); if(!rd)return;
    const d=rd.data(); 
    clients.forEach((c, i) => { const cb = document.getElementById('c'+i); if(cb) cb.checked = false; });
    lastRouteClients = clients.filter(c => {
        const isIncluded = d.clients.includes(c.id);
        if(isIncluded) { const idx = clients.indexOf(c); const cb = document.getElementById('c'+idx); if(cb) { cb.checked = true; markers[idx].setIcon(iconPin); } }
        return isIncluded;
    });
    currentStartOption = d.mode || "gps";
    lastRouteCoords=[[d.start.lat,d.start.lng],...lastRouteClients.map(c=>[c.lat,c.lng])];
    drawRoute(lastRouteCoords);
}

window.openInGoogleMaps=function(){ 
    if(lastRouteCoords.length<2) return alert("Crea o carga una ruta"); 
    let origin = (currentStartOption === "gps") ? "" : lastRouteCoords[0].join(',');
    let dest = lastRouteClients[lastRouteClients.length-1];
    let destination = dest.address ? encodeURIComponent(dest.address) : (dest.lat+','+dest.lng);
    let waypoints = lastRouteClients.slice(0,-1).map(c=>c.address?encodeURIComponent(c.address):(c.lat+','+c.lng)).join('|');
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}&travelmode=driving`,'_blank'); 
}

// NUEVO: Abrir Waze
window.openInWaze = function() {
    if(lastRouteCoords.length<2) return alert("Crea o carga una ruta"); 
    const dest = lastRouteClients[lastRouteClients.length-1];
    const destination = dest.lat && dest.lng ? `${dest.lat},${dest.lng}` : encodeURIComponent(dest.address || "");
    // Waze solo necesita destino, el navegador se encarga de origen
    const url = `https://waze.com/ul?ll=${destination}&navigate=yes`;
    window.open(url,'_blank');
}

// Usuario ðŸ“
let userMarker = null;
async function showUserPosition() {
    try {
        const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject));
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lng], {icon: iconUser}).addTo(map).bindPopup("ðŸ“ TÃº estÃ¡s aquÃ­").openPopup();
        map.setView([lat, lng], 13);
    } catch(e) { console.warn("No se pudo obtener la ubicaciÃ³n: ", e); }
}

window.login=async function(){ 
    try { await signInWithEmailAndPassword(auth,document.getElementById('email').value,document.getElementById('password').value); alert("Login OK"); cargarClientes(); cargarRutas(); showUserPosition(); } catch(e){ alert("Error: "+e.message); }
}

document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById('btnLogin').addEventListener('click',login);
    document.getElementById('btnAddClient').addEventListener('click',addClient);
    document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
    document.getElementById('btnGoogleMaps').addEventListener('click',window.openInGoogleMaps);
    document.getElementById('btnWaze').addEventListener('click',window.openInWaze);
    document.getElementById('btnClearRoute').addEventListener('click',()=>{ if(routeLine)map.removeLayer(routeLine); redMarkers.forEach(m=>map.removeLayer(m)); });
    document.getElementById('startOption').addEventListener('change',e=>document.getElementById('startAddress').style.display=e.target.value==="manual"?"block":"none");
    cargarClientes(); cargarRutas(); showUserPosition();
});
</script>
</body>
</html>
