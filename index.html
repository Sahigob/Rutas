<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO v2.4</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root {
  --primary: #0ea5e9;
  --primary-dark: #0284c7;
  --bg: #f8fafc;
  --card-bg: #ffffff;
  --text: #1e293b;
  --border: #e2e8f0;
}

body { margin:0; font-family: 'Segoe UI', system-ui, sans-serif; display:flex; flex-direction: row; height:100vh; background: var(--bg); color: var(--text); }
#map { flex:1; height: 100%; z-index: 1; }
#panel { width:400px; padding:24px; overflow-y:auto; background: var(--card-bg); border-left: 1px solid var(--border); box-sizing: border-box; box-shadow: -4px 0 15px rgba(0,0,0,0.05); z-index: 10; }

@media (max-width: 768px) { 
  body { flex-direction: column; } 
  #map { flex: none; height: 35vh; } 
  #panel { width: 100%; flex: 1; border-left: none; border-top: 2px solid var(--border); }
}

h3 { margin: 24px 0 12px 0; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
h3::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 4px; }

.card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }

button { 
  width:100%; padding:12px; margin:8px 0; border-radius:10px; border:none; background: var(--primary); color:white; 
  font-weight:600; cursor:pointer; font-size: 14px; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
}
button:hover { background: var(--primary-dark); }
button:active { transform: scale(0.98); }

.smallBtn { padding:6px 12px; font-size:12px; margin: 4px 2px; width: auto; display: inline-flex; }
.deleteBtn { background:#ef4444; }
.deleteBtn:hover { background:#dc2626; }

input, select, textarea { 
  width:100%; margin:8px 0; padding:12px; border-radius:10px; border:1px solid var(--border); box-sizing: border-box; font-size: 14px; 
}

.client { padding:12px; border: 1px solid var(--border); background: white; margin-bottom: 8px; border-radius: 10px; }
.stats-badge { background: #e0f2fe; color: #0369a1; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }
label { font-weight: 600; font-size: 13px; margin-bottom: 4px; display: block; }
input[type="checkbox"] { width: auto; transform: scale(1.4); margin-right: 12px; cursor: pointer; }

.routeItem { 
    display:flex; justify-content:space-between; align-items:center; 
    margin-bottom:8px; font-size:13px; background:#f1f5f9; 
    padding:8px 12px; border-radius:10px; border:1px solid #e2e8f0;
}

/* Modal Styles */
#editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999; }
#editModal .modal-content { background:white; padding:24px; border-radius:12px; width:90%; max-width:400px; box-sizing:border-box; }
#editModal input, #editModal textarea { margin:8px 0; }
#editModal .modal-buttons { display:flex; justify-content:space-between; margin-top:16px; }
#editModal .modal-buttons button { width:48%; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <div class="card">
    <h3>üîê Login</h3>
    <input id="email" placeholder="Correo electr√≥nico" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Iniciar sesi√≥n</button>
  </div>

  <div class="card">
    <h3>üë• Gesti√≥n de Cliente</h3>
    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="Direcci√≥n manual" />
    <textarea id="notes" placeholder="Notas (ej: Hotel, Restaurante...)" rows="2"></textarea>
    <div style="display:flex; gap:8px">
        <input id="lat" placeholder="Latitud" />
        <input id="lng" placeholder="Longitud" />
    </div>
    <button id="btnAddClient">‚ûï Guardar cliente</button>
  </div>

  <div class="card">
    <h3>üß≠ Planificador de Ruta</h3>
    <label>Fecha:</label>
    <input type="date" id="routeDate" />
    <label>Salida:</label>
    <select id="startOption">
      <option value="gps">üìç Mi ubicaci√≥n actual</option>
      <option value="manual">‚úèÔ∏è Direcci√≥n manual</option>
    </select>
    <input id="startAddress" placeholder="Direcci√≥n de salida" style="display:none"/>
    <button id="btnCreateRoute">üß≠ Crear ruta</button>
    <div id="routeList"></div>
  </div>

  <div class="card">
    <h3>üöó Navegaci√≥n</h3>
    <button id="btnGoogleMaps" style="background: #22c55e;">üåê Abrir Google Maps</button>
    <button id="btnWaze" style="background: #1e40af;">üõ£Ô∏è Abrir Waze</button>
    <button id="btnClearRoute" style="background: #64748b;">üßπ Limpiar mapa</button>
  </div>

  <h3>üìä Clientes <span id="stats" class="stats-badge">0</span></h3>
  <div id="clientList"></div>
</div>

<!-- Modal de edici√≥n -->
<div id="editModal">
  <div class="modal-content">
    <h3>Editar Cliente</h3>
    <input id="editName" placeholder="Nombre cliente" />
    <input id="editAddress" placeholder="Direcci√≥n manual" />
    <textarea id="editNotes" placeholder="Notas (ej: Hotel, Restaurante...)" rows="2"></textarea>
    <div style="display:flex; gap:8px">
        <input id="editLat" placeholder="Latitud" />
        <input id="editLng" placeholder="Longitud" />
    </div>
    <div class="modal-buttons">
        <button id="btnSaveEdit">üíæ Guardar</button>
        <button id="btnCancelEdit" class="deleteBtn">‚ùå Cancelar</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[], lastRouteClients=[];
let editingClientId = null, currentStartOption = "gps";

const iconNormal = new L.Icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[25,41], iconAnchor:[12,41] });
const iconFood = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/3448/3448609.png", iconSize:[38,38], iconAnchor:[19,38] });
const iconHotel = new L.Icon({ 
    iconUrl: "data:image/svg+xml;base64," + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 38 38"><circle cx="19" cy="19" r="18" fill="#ff9900" stroke="white" stroke-width="2"/><text x="50%" y="55%" font-size="18" text-anchor="middle" fill="black" font-family="Arial" font-weight="bold" dominant-baseline="middle">H</text></svg>`), 
    iconSize:[38,38], iconAnchor:[19,38] 
});
const iconPin = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32], iconAnchor:[16,32] });
const iconUser = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[40,40], iconAnchor:[20,40] });

function getClientIcon(cliente){
  const text=(cliente.notes||"").toLowerCase();
  if(text.includes("comida")||text.includes("bar")||text.includes("restaurante")) return iconFood;
  if(text.includes("hotel")||text.includes("hostal")||text.includes("dormir")) return iconHotel;
  return iconNormal;
}

let map = L.map('map').setView([40.4168,-3.7038],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

async function geocode(addr){ let res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`); let data=await res.json(); return data.length>0 ? {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon)} : null; }

async function cargarClientes(){ 
    const snapshot=await getDocs(coleccionClientes); 
    clients=snapshot.docs.map(d=>({...d.data(),id:d.id})).filter(c=>c.name); 
    clients.sort((a,b)=>a.name.localeCompare(b.name)); 
    renderClientes(); 
}

async function cargarRutas(){ 
    const snapshot=await getDocs(coleccionRutas); 
    const container=document.getElementById('routeList'); container.innerHTML=""; 
    snapshot.docs.forEach(docSnap => {
        const r = docSnap.data();
        let div=document.createElement('div'); div.className="routeItem";
        div.innerHTML=`<span>üìÖ ${r.date || 'Sin fecha'}</span> 
            <div>
                <button class="smallBtn" onclick="loadRoute('${docSnap.id}')">üëÅÔ∏è Ver</button>
                <button class="smallBtn deleteBtn" onclick="deleteRoute('${docSnap.id}')">üóëÔ∏è</button>
            </div>`;
        container.appendChild(div);
    });
}

function renderClientes(){ 
    const container=document.getElementById('clientList'); container.innerHTML=""; 
    markers.forEach(m=>map.removeLayer(m)); markers=[]; 
    clients.forEach((c,i)=>{ 
        let div=document.createElement('div'); div.className='client'; 
        div.innerHTML=`<div style="display:flex; align-items:center;">
                <input type="checkbox" id="c${i}" data-id="${c.id}"> 
                <div style="flex:1">
                    <b>${c.name}</b><br><small>${c.address||'Sin direcci√≥n'}</small>
                </div>
            </div>
            <div style="margin-top:8px">
                <button class="smallBtn" onclick='openEditModal("${c.id}")'>‚úèÔ∏è Editar</button>
                <button class="smallBtn deleteBtn" onclick='deleteClient("${c.id}")'>üóëÔ∏è</button>
            </div>`;
        container.appendChild(div);

        if(c.lat && c.lng){ 
            const defaultIcon = getClientIcon(c);
            let m = L.marker([c.lat,c.lng], {icon: defaultIcon}).addTo(map).bindPopup(c.name);
            const updateMarkerIcon = (checked) => { m.setIcon(checked ? iconPin : defaultIcon); };
            m.on('click', () => { 
                const cb = document.getElementById('c'+i); 
                cb.checked = !cb.checked; 
                updateMarkerIcon(cb.checked); 
            });
            setTimeout(() => {
                const cb = document.getElementById('c'+i);
                if(cb) cb.addEventListener('change', () => updateMarkerIcon(cb.checked));
            }, 100);
            markers.push(m);
        }
    }); 
    document.getElementById('stats').innerHTML=clients.length; 
}

// NUEVO: Modal edici√≥n
window.openEditModal = function(id) {
    const c = clients.find(x => x.id === id);
    if(!c) return;
    editingClientId = id;
    document.getElementById('editName').value = c.name || '';
    document.getElementById('editAddress').value = c.address || '';
    document.getElementById('editNotes').value = c.notes || '';
    document.getElementById('editLat').value = c.lat || '';
    document.getElementById('editLng').value = c.lng || '';
    document.getElementById('editModal').style.display = 'flex';
};

document.getElementById('btnCancelEdit').addEventListener('click', ()=> {
    editingClientId = null;
    document.getElementById('editModal').style.display = 'none';
});

document.getElementById('btnSaveEdit').addEventListener('click', async ()=> {
    const name = document.getElementById('editName').value.trim();
    const address = document.getElementById('editAddress').value.trim();
    const notes = document.getElementById('editNotes').value.trim();
    const lat = parseFloat(document.getElementById('editLat').value);
    const lng = parseFloat(document.getElementById('editLng').value);
    if(!name) return alert("Pon nombre");
    try{
        await updateDoc(doc(db,"clientes",editingClientId),{name,address,lat,lng,notes});
        editingClientId = null;
        document.getElementById('editModal').style.display = 'none';
        cargarClientes();
    }catch(e){ alert("Error: "+e.message);}
});

// Mantener funci√≥n original para agregar nuevo cliente
window.addClient=async function(){ 
    const name=document.getElementById('name').value.trim(), address=document.getElementById('address').value.trim(), notes=document.getElementById('notes').value.trim(), latIn=document.getElementById('lat').value, lngIn=document.getElementById('lng').value;
    if(!name) return alert("Pon nombre");
    let lat, lng;
    if(latIn && lngIn){ lat=parseFloat(latIn); lng=parseFloat(lngIn); }
    else if(address){ const co=await geocode(address); if(!co) return alert("No encontrada"); lat=co.lat; lng=co.lng; }
    else { try { const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j)); lat=pos.coords.latitude; lng=pos.coords.longitude; } catch(e){ return alert("GPS error"); } }
    try {
        await addDoc(coleccionClientes,{name,address,lat,lng,notes}); 
        document.getElementById('name').value=""; document.getElementById('address').value=""; document.getElementById('notes').value=""; document.getElementById('lat').value=""; document.getElementById('lng').value="";
        cargarClientes();
    } catch(e) { alert("Error: " + e.message); }
}

// ... aqu√≠ se mantiene todo el resto de tus funciones de rutas, navegaci√≥n y login sin cambios ...

</script>
</body>
</html>
