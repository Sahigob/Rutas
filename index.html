<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rutas Comerciales PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
    #map { flex:1 }
    #panel { width:350px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
    button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
    button:hover { background:#0284c7 }
    .client { padding:8px; border-bottom:1px solid #ddd }
    .deleteBtn{background:#ef4444;margin-top:6px}
    .deleteBtn:hover{background:#dc2626}
    input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
    small { color:#555 }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Clientes</h3>

    <input id="email" placeholder="Correo" />
    <input id="password" type="password" placeholder="ContraseÃ±a" />
    <button onclick="login()">ðŸ”‘ Iniciar sesiÃ³n</button>

    <hr>

    <input id="name" placeholder="Nombre cliente" />
    <input id="address" placeholder="DirecciÃ³n manual (opcional)" />
    <textarea id="notes" placeholder="Notas"></textarea>
    <select id="day">
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="MiÃ©rcoles">MiÃ©rcoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
    </select>

    <button onclick="addClient()">âž• Guardar cliente</button>
    <button onclick="calculateRoute()">ðŸ§­ Calcular mejor ruta</button>
    <button onclick="openInGoogleMaps()">ðŸ—º Abrir en Google Maps</button>
    <button onclick="openInWaze()">ðŸš— Abrir en Waze</button>
    <button onclick="exportClients()">ðŸ’¾ Exportar clientes</button>
    <button onclick="importClients()">ðŸ“‚ Importar clientes</button>

    <h3>Filtrar por dÃ­a</h3>
    <select id="filterDay" onchange="render()">
      <option value="Todos">Todos</option>
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="MiÃ©rcoles">MiÃ©rcoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
    </select>

    <h3>EstadÃ­sticas</h3>
    <div id="stats"></div>

    <h3>Listado</h3>
    <div id="clientList"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROYECTO.firebaseapp.com",
  projectId: "TU_PROYECTO",
  storageBucket: "TU_PROYECTO.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db, "clientes");

let map = L.map('map').setView([40.4168, -3.7038], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let clients = [];
let markers = [];
let routeLine;
let lastRouteCoords = [];

// Login con Firebase
async function login(){
  const correo = document.getElementById('email').value;
  const contrasena = document.getElementById('password').value;
  try{
    const userCredential = await signInWithEmailAndPassword(auth, correo, contrasena);
    alert('Login exitoso: ' + userCredential.user.email);
    cargarClientesDesdeFirestore();
  } catch(error){
    alert('Error al iniciar sesiÃ³n: ' + error.message);
  }
}

// Cargar clientes desde Firestore
async function cargarClientesDesdeFirestore(){
  const snapshot = await getDocs(coleccionClientes);
  clients = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
  render();
}

// Agregar cliente a Firestore
async function addClient(){
  let name=document.getElementById('name').value;
  let address=document.getElementById('address').value;
  let notes=document.getElementById('notes').value;
  let day=document.getElementById('day').value;
  if(!name) return alert('Pon nombre');

  let lat,lng;
  if(address){
    let coords = await geocode(address);
    if(coords){ lat=coords.lat; lng=coords.lng; }
    else return alert('No se encontrÃ³ direcciÃ³n');
  } else {
    navigator.geolocation.getCurrentPosition(async pos=>{
      lat = pos.coords.latitude;
      lng = pos.coords.longitude;
      await addClientToFirestore({name,lat,lng,notes,day,visits:0});
    });
    return;
  }

  await addClientToFirestore({name,address,lat,lng,notes,day,visits:0});
}

async function addClientToFirestore(cliente){
  await addDoc(coleccionClientes, cliente);
  cargarClientesDesdeFirestore();
}

async function deleteClient(id){
  if(!confirm('Â¿Seguro que quieres borrar este cliente?')) return;
  await deleteDoc(doc(db, "clientes", id));
  cargarClientesDesdeFirestore();
}

// Mantener resto de funciones como geocode, calculateRoute, render, openInGoogleMaps, openInWaze, export/import etc.
// Puedes copiar exactamente las funciones existentes de tu cÃ³digo para estas acciones.
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
