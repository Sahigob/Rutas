<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh }
#map { flex:1 }
#panel { width:400px; padding:12px; overflow:auto; background:#f7f7f7; border-left:1px solid #ddd }
button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#0ea5e9; color:white; font-weight:600; cursor:pointer }
button:hover { background:#0284c7 }
.client, .routeItem { padding:8px; border-bottom:1px solid #ddd }
.deleteBtn{background:#ef4444;margin-top:6px}
.deleteBtn:hover{background:#dc2626}
input, select, textarea { width:100%; margin:4px 0; padding:6px; border-radius:6px; border:1px solid #ccc }
small { color:#555 }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
<h3>Login</h3>
<input id="email" placeholder="Correo" />
<input id="password" type="password" placeholder="Contrase√±a" />
<button id="btnLogin">üîë Iniciar sesi√≥n</button>
<hr>

<h3>Clientes</h3>
<input id="name" placeholder="Nombre cliente" />
<input id="address" placeholder="Direcci√≥n manual (opcional)" />
<textarea id="notes" placeholder="Notas"></textarea>
<input id="lat" placeholder="Latitud (opcional)" />
<input id="lng" placeholder="Longitud (opcional)" />
<button id="btnAddClient">‚ûï Guardar cliente</button>
<hr>

<h3>Crear Ruta</h3>
<label>Fecha:</label>
<input type="date" id="routeDate" />
<label>Ubicaci√≥n de salida:</label>
<select id="startOption">
<option value="current">Desde mi ubicaci√≥n</option>
<option value="manual">Ingresar direcci√≥n</option>
</select>
<input id="startAddress" placeholder="Direcci√≥n de salida" style="display:none" />
<button id="btnCreateRoute">üß≠ Crear y guardar ruta</button>
<hr>

<h3>Rutas Guardadas</h3>
<div id="routeList"></div>
<hr>

<h3>Estad√≠sticas</h3>
<div id="stats"></div>

<h3>Listado Clientes</h3>
<div id="clientList"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE",
  authDomain: "rutas-56f86.firebaseapp.com",
  projectId: "rutas-56f86",
  storageBucket: "rutas-56f86.appspot.com",
  messagingSenderId: "1026881492897",
  appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

window.clients=[]; let markers=[]; let redMarkers=[]; let routeLine=null; let lastRouteCoords=[];

// MAPA
let map = L.map('map').setView([40.4168, -3.7038], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// LOGIN
window.login = async function(){
  const correo = document.getElementById('email').value;
  const contrasena = document.getElementById('password').value;
  try {
    const userCredential = await signInWithEmailAndPassword(auth, correo, contrasena);
    alert("Login exitoso: "+userCredential.user.email);
    await cargarClientes();
    await cargarRutas();
  } catch(e){ alert("Error login: "+e.message); }
};

// CLIENTES
window.addClient = async function(){
  const name=document.getElementById('name').value;
  if(!name) return alert("Pon nombre del cliente");
  const address=document.getElementById('address').value;
  const notes=document.getElementById('notes').value;
  const latInput=document.getElementById('lat').value;
  const lngInput=document.getElementById('lng').value;
  let lat,lng;

  if(latInput && lngInput){ lat=parseFloat(latInput); lng=parseFloat(lngInput);}
  else if(address){ const c=await geocode(address); if(!c) return alert("No se encontr√≥ direcci√≥n"); lat=c.lat; lng=c.lng; }
  else{ try{ const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej)); lat=pos.coords.latitude; lng=pos.coords.longitude;} catch(e){return alert("No se pudo obtener ubicaci√≥n");} }

  await addDoc(coleccionClientes,{name,address,lat,lng,notes,visits:0});
  await cargarClientes();
};

window.deleteClient = async function(id){ if(!confirm("Borrar cliente?")) return; await deleteDoc(doc(db,"clientes",id)); await cargarClientes(); };

async function cargarClientes(){
  const snapshot = await getDocs(coleccionClientes);
  window.clients = snapshot.docs.map(d=>({...d.data(),id:d.id}));
  window.clients.sort((a,b)=>a.name.localeCompare(b.name));
  renderClients();
}

function renderClients(){
  document.getElementById('clientList').innerHTML="";
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  window.clients.forEach((c,i)=>{
    const div=document.createElement('div'); div.className="client";
    div.innerHTML=`<input type=checkbox id=c${i}> <b>${c.name}</b><br>
      <small>${c.address|| (c.lat?.toFixed(5)+','+c.lng?.toFixed(5))}</small><br>
      <small>üìù ${c.notes||''}</small><br>
      <small>Visitas: ${c.visits||0}</small>
      <button class='deleteBtn' onclick='deleteClient("${c.id}")'>üóëÔ∏è Borrar</button>`;
    document.getElementById('clientList').appendChild(div);
    if(c.lat && c.lng){ markers.push(L.marker([c.lat,c.lng]).addTo(map).bindPopup(c.name)); }
  });
  const totalVisits = window.clients.reduce((sum,c)=>sum+(c.visits||0),0);
  document.getElementById('stats').innerHTML=`Clientes totales: ${window.clients.length}<br>Total visitas: ${totalVisits}`;
}

// RUTAS
document.getElementById('startOption').addEventListener('change',()=>{ document.getElementById('startAddress').style.display=document.getElementById('startOption').value==='manual'?'block':'none'; });

window.createRoute = async function(){
  const date=document.getElementById('routeDate').value;
  if(!date) return alert("Elige fecha");
  let start;
  if(document.getElementById('startOption').value==='current'){
    try{ const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej)); start={lat:pos.coords.latitude,lng:pos.coords.longitude}; }
    catch(e){ return alert("No se pudo obtener ubicaci√≥n"); }
  } else {
    const addr=document.getElementById('startAddress').value; if(!addr) return alert("Ingresa direcci√≥n"); const c=await geocode(addr); if(!c) return alert("Direcci√≥n no encontrada"); start=c;
  }

  const selected = window.clients.filter((c,i)=>document.getElementById('c'+i)?.checked);
  if(selected.length<1) return alert("Selecciona clientes");
  const clientIds = selected.map(c=>c.id);

  await addDoc(coleccionRutas,{date,clients:clientIds,start});
  await cargarRutas();
  alert("Ruta guardada");
};

async function cargarRutas(){
  const snapshot = await getDocs(coleccionRutas);
  const rutas = snapshot.docs.map(d=>({...d.data(),id:d.id})).sort((a,b)=>a.date.localeCompare(b.date));
  const container=document.getElementById('routeList'); container.innerHTML="";
  rutas.forEach(r=>{
    const existing = window.clients.filter(c=>r.clients.includes(c.id));
    if(existing.length===0) return;
    const div=document.createElement('div'); div.className="routeItem";
    div.innerHTML=`${r.date} (${existing.length} clientes)
      <button onclick="loadRoute('${r.id}')">üü¢ Ver</button>
      <button onclick="deleteRoute('${r.id}')">üóëÔ∏è Borrar</button>`;
    container.appendChild(div);
  });
}

window.deleteRoute = async function(id){ if(!confirm("Borrar ruta?")) return; await deleteDoc(doc(db,"rutas",id)); await cargarRutas(); };

window.loadRoute = async function(id){
  const snapshot = await getDocs(coleccionRutas);
  const docR = snapshot.docs.find(d=>d.id===id); if(!docR) return alert("Ruta no encontrada");
  const data = docR.data();
  const selected = window.clients.filter(c=>data.clients.includes(c.id));
  if(selected.length<1) return alert("No hay clientes disponibles");
  lastRouteCoords = [[data.start.lat,data.start.lng], ...selected.map(c=>[c.lat,c.lng])];
  drawRoute(lastRouteCoords);
};

// DRAW ROUTE
function drawRoute(coords){
  if(routeLine) map.removeLayer(routeLine);
  redMarkers.forEach(m=>map.removeLayer(m)); redMarkers=[];
  routeLine=L.polyline(coords,{color:'red'}).addTo(map);
  map.fitBounds(routeLine.getBounds());
  coords.slice(1).forEach(c=>{
    redMarkers.push(L.circleMarker(c,{radius:8,color:'red',fillColor:'red',fillOpacity:0.6}).addTo(map));
  });
}

// GOOGLE MAPS / WAZE
window.openInGoogleMaps = function(){
  if(lastRouteCoords.length<2) return alert("Calcula ruta primero");
  const origin = lastRouteCoords[0].slice().reverse().join(',');
  const waypoints = lastRouteCoords.slice(1).map(c=>c.slice().reverse().join(',')).join('|');
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&waypoints=${waypoints}`,'_blank');
};

window.openInWaze = function(){
  if(lastRouteCoords.length<2) return alert("Calcula ruta primero");
  const dest = lastRouteCoords[lastRouteCoords.length-1].slice().reverse().join(',');
  window.open(`https://waze.com/ul?ll=${dest}&navigate=yes`,'_blank');
};

// GEOCODE
async function geocode(addr){
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  const data = await res.json(); if(data.length>0) return {lat:parseFloat(data[0].lat),lng:parseFloat(data[0].lon)}; return null;
}

// EVENT LISTENERS
document.getElementById('btnLogin').addEventListener('click',login);
document.getElementById('btnAddClient').addEventListener('click',addClient);
document.getElementById('btnCreateRoute').addEventListener('click',createRoute);
</script>
</body>
</html>
