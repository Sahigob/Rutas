<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rutas Comerciales PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    :root { --primary: #0ea5e9; --success: #22c55e; --danger: #ef4444; --gray: #64748b; --bg: #f8fafc; }
    body { margin:0; font-family: 'Segoe UI', Roboto, sans-serif; display:flex; height:100vh; background: var(--bg); }

    #map { flex:1; height: 100%; }
    #panel { width:400px; display:flex; flex-direction: column; background:white; border-left:1px solid #e2e8f0; box-shadow: -2px 0 10px rgba(0,0,0,0.05); z-index: 1000; }

    /* Navegaci√≥n por Pesta√±as */
    .tabs { display: flex; background: #f1f5f9; padding: 5px; gap: 5px; border-bottom: 1px solid #e2e8f0; }
    .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: transparent; color: var(--gray); transition: 0.2s; font-size: 14px; }
    .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    .tab-content { display: none; padding: 16px; overflow-y: auto; flex: 1; }
    .tab-content.active { display: block; }

    h3 { margin: 0 0 15px 0; font-size: 1.1rem; color: #1e293b; border-left: 4px solid var(--primary); padding-left: 10px; }
    .card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 15px; }
    
    input, select, textarea { width:100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; font-size: 15px; }
    button { width:100%; padding: 12px; margin: 8px 0; border-radius: 10px; border:none; background: var(--primary); color:white; font-weight:600; cursor:pointer; transition: 0.2s; font-size: 15px; }
    button:hover { opacity: 0.9; }
    button:active { transform: scale(0.98); }
    
    .smallBtn { width: auto; padding: 6px 10px; font-size: 12px; margin: 2px; display: inline-block; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    
    /* Lista de Clientes con Checkbox */
    .client-item { display: flex; align-items: flex-start; gap: 12px; padding: 10px; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
    .client-item:hover { background: #f8fafc; }
    .client-checkbox { width: 22px; height: 22px; cursor: pointer; margin-top: 3px; accent-color: var(--primary); }
    .client-info { flex: 1; cursor: pointer; }
    .client-info b { display: block; color: #1e293b; font-size: 14px; }
    .client-info small { color: var(--gray); font-size: 12px; }

    @media (max-width: 768px) { 
        body { flex-direction: column; } 
        #map { height: 35vh; flex: none; } 
        #panel { width: 100%; flex: 1; }
    }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('tab-clientes')">üë• Clientes</button>
        <button class="tab-btn" onclick="openTab('tab-ruta')">üß≠ Crear Ruta</button>
        <button class="tab-btn" onclick="openTab('tab-login')">üîë Login</button>
    </div>

    <div id="tab-clientes" class="tab-content active">
        <h3>Lista de Clientes</h3>
        <p style="font-size: 12px; color: var(--gray); margin-bottom: 10px;">Selecciona los clientes que vas a visitar hoy:</p>
        <div id="clientList"></div>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <h3>A√±adir Nuevo</h3>
        <div class="card">
            <input id="name" placeholder="Nombre del cliente" />
            <input id="address" placeholder="Direcci√≥n (o usa GPS)" />
            <textarea id="notes" placeholder="Notas (comida, hotel...)" rows="1"></textarea>
            <button id="btnAddClient">‚ûï Guardar en Agenda</button>
        </div>
    </div>

    <div id="tab-ruta" class="tab-content">
        <h3>Configuraci√≥n de Ruta</h3>
        <div class="card">
            <label style="font-size: 12px; font-weight: bold;">Fecha:</label>
            <input type="date" id="routeDate" />
            
            <label style="font-size: 12px; font-weight: bold;">Punto de Partida:</label>
            <select id="startOption">
                <option value="gps">üìç Mi ubicaci√≥n actual (GPS)</option>
                <option value="manual">‚úèÔ∏è Direcci√≥n espec√≠fica</option>
            </select>
            <input id="startAddress" placeholder="Direcci√≥n de salida..." style="display:none"/>
            
            <button id="btnCreateRoute" style="background: var(--success);">üß≠ Generar Ruta con Seleccionados</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button id="btnGoogleMaps" style="background:#34a853">Google Maps</button>
            <button id="btnWaze" style="background:#33ccff">Waze</button>
        </div>
        <button id="btnClearRoute" class="btn-outline">üßπ Limpiar Mapa</button>

        <h4>Rutas Guardadas</h4>
        <div id="routeList"></div>
    </div>

    <div id="tab-login" class="tab-content">
        <h3>Sincronizaci√≥n Cloud</h3>
        <div class="card">
            <input id="email" placeholder="Email" />
            <input id="password" type="password" placeholder="Contrase√±a" />
            <button id="btnLogin">üîë Iniciar Sesi√≥n</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyALty_4SfeZUg6B6_dbcOeZvGYpnu4gYsE", authDomain: "rutas-56f86.firebaseapp.com", projectId: "rutas-56f86", storageBucket: "rutas-56f86.appspot.com", messagingSenderId: "1026881492897", appId: "1:1026881492897:web:fcb315b53fcf5e40e3dde0" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const coleccionClientes = collection(db,"clientes");
const coleccionRutas = collection(db,"rutas");

let clients=[], markers=[], redMarkers=[], routeLine, lastRouteCoords=[], lastRouteClients=[];
let currentStartMode = "gps";

// Iconos
const iconNormal = new L.Icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[25,41], iconAnchor:[12,41] });
const iconFood = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/3448/3448609.png", iconSize:[35,35], iconAnchor:[17,35] });
const iconPin = new L.Icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[30,30], iconAnchor:[15,30] });

// Mapa
let map = L.map('map').setView([40.4168,-3.7038], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Tabs
window.openTab = function(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
}

// Cargar Clientes
async function cargarClientes() {
    const sn = await getDocs(coleccionClientes);
    clients = sn.docs.map(d => ({...d.data(), id: d.id})).filter(c => c.name);
    clients.sort((a,b) => a.name.localeCompare(b.name));
    renderClientes();
}

function renderClientes() {
    const cont = document.getElementById('clientList'); cont.innerHTML = "";
    markers.forEach(m => map.removeLayer(m)); markers = [];
    
    clients.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = "client-item";
        div.innerHTML = `
            <input type="checkbox" class="client-checkbox" id="check-${i}" data-id="${c.id}">
            <div class="client-info" onclick="document.getElementById('check-${i}').click()">
                <b>${c.name}</b>
                <small>${c.address || 'Sin direcci√≥n'}</small>
            </div>
            <button class="smallBtn btn-outline" onclick="deleteClient('${c.id}')">üóëÔ∏è</button>
        `;
        cont.appendChild(div);

        if(c.lat && c.lng) {
            let icon = (c.notes||"").toLowerCase().includes("comida") ? iconFood : iconNormal;
            let m = L.marker([c.lat, c.lng], {icon: icon}).addTo(map).bindPopup(c.name);
            m.cId = c.id;
            m.on('click', () => { 
                let cb = document.getElementById(`check-${i}`);
                cb.checked = !cb.checked;
                m.setIcon(cb.checked ? iconPin : icon);
            });
            markers.push(m);
        }
    });
}

// Crear Ruta - L√≥gica corregida
window.createRoute = async function() {
    // Obtenemos IDs de los checkboxes marcados (aunque est√©n en otra pesta√±a)
    const selectedCheckboxes = document.querySelectorAll('.client-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-id'));
    
    if(selectedIds.length === 0) return alert("Por favor, marca al menos un cliente en la pesta√±a 'Clientes'");

    let selClients = clients.filter(c => selectedIds.includes(c.id));
    currentStartMode = document.getElementById('startOption').value;
    let sLat, sLng;

    try {
        if(currentStartMode === "gps") {
            const p = await new Promise((r,j) => navigator.geolocation.getCurrentPosition(r,j));
            sLat = p.coords.latitude; sLng = p.coords.longitude;
        } else {
            let addr = document.getElementById('startAddress').value;
            let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
            let data = await res.json();
            if(data.length === 0) return alert("No se encontr√≥ la direcci√≥n de salida");
            sLat = parseFloat(data[0].lat); sLng = parseFloat(data[0].lon);
        }

        lastRouteClients = selClients;
        lastRouteCoords = [[sLat, sLng], ...selClients.map(c => [c.lat, c.lng])];
        
        // Guardar en Firebase
        await addDoc(coleccionRutas, {
            date: document.getElementById('routeDate').value || new Date().toISOString().split('T')[0],
            clients: selectedIds,
            start: {lat: sLat, lng: sLng},
            mode: currentStartMode
        });

        drawRoute(lastRouteCoords);
        cargarRutas();
        alert("Ruta generada con √©xito");
        
    } catch(e) { alert("Error al obtener ubicaci√≥n: " + e.message); }
}

function drawRoute(coords) {
    if(routeLine) map.removeLayer(routeLine);
    redMarkers.forEach(m => map.removeLayer(m)); redMarkers = [];

    const str = coords.map(c => c[1]+","+c[0]).join(";");
    fetch(`https://router.project-osrm.org/trip/v1/driving/${str}?source=first&roundtrip=false&overview=full&geometries=geojson`)
    .then(r => r.json()).then(d => {
        if(!d.trips) return;
        routeLine = L.geoJSON(d.trips[0].geometry, {style: {color: '#0ea5e9', weight: 5}}).addTo(map);
        map.fitBounds(routeLine.getBounds().pad(0.1));
        coords.slice(1).forEach(c => {
            let dot = L.circleMarker(c, {radius: 6, color: 'red', fillOpacity: 1}).addTo(map);
            redMarkers.push(dot);
        });
    });
}

// Navegaci√≥n Externa Corregida
window.openInGoogleMaps = function() {
    if(lastRouteCoords.length < 2) return alert("Crea una ruta primero");
    let origin = (currentStartMode === "gps") ? "" : lastRouteCoords[0].join(',');
    let destPoint = lastRouteClients[lastRouteClients.length - 1];
    let dest = destPoint.address ? encodeURIComponent(destPoint.address) : (destPoint.lat + ',' + destPoint.lng);
    let waypoints = lastRouteClients.slice(0, -1).map(c => c.address ? encodeURIComponent(c.address) : (c.lat+','+c.lng)).join('|');
    
    window.open(`https://www.google.com/search?q=https://www.google.com/maps/search/%3Fapi%3D1%26query%3D39.0644979,-0.565455%26query_place_id%3DChIJv5FQE9agYQ0RVkOtbdieD74{origin}&destination=${dest}&waypoints=${waypoints}&travelmode=driving`, '_blank');
}

// Funciones Auxiliares
window.addClient = async function() {
    const n = document.getElementById('name').value;
    const a = document.getElementById('address').value;
    if(!n) return alert("Nombre necesario");
    let lat, lng;
    if(a) {
        let r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}`);
        let d = await r.json();
        if(d.length>0) { lat=parseFloat(d[0].lat); lng=parseFloat(d[0].lon); }
    }
    if(!lat) {
        const p = await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j));
        lat=p.coords.latitude; lng=p.coords.longitude;
    }
    await addDoc(coleccionClientes, {name: n, address: a, notes: document.getElementById('notes').value, lat, lng});
    document.getElementById('name').value=""; document.getElementById('address').value="";
    cargarClientes();
}

window.deleteClient = async function(id) { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db,"clientes",id)); cargarClientes(); } }

async function cargarRutas() {
    const sn = await getDocs(coleccionRutas);
    const cont = document.getElementById('routeList'); cont.innerHTML = "";
    sn.docs.forEach(doc => {
        const r = doc.data();
        let div = document.createElement('div'); div.className="routeItem";
        div.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; font-size:13px";
        div.innerHTML = `<span>${r.date}</span> <button class="smallBtn btn-outline" onclick="loadRouteData('${doc.id}')">Ver</button>`;
        cont.appendChild(div);
    });
}

window.loadRouteData = async function(id) {
    const sn = await getDocs(coleccionRutas);
    const r = sn.docs.find(d => d.id === id).data();
    currentStartMode = r.mode || "gps";
    lastRouteClients = clients.filter(c => r.clients.includes(c.id));
    lastRouteCoords = [[r.start.lat, r.start.lng], ...lastRouteClients.map(c => [c.lat, c.lng])];
    drawRoute(lastRouteCoords);
    openTab('tab-ruta');
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('btnAddClient').addEventListener('click', addClient);
    document.getElementById('btnCreateRoute').addEventListener('click', createRoute);
    document.getElementById('btnGoogleMaps').addEventListener('click', openInGoogleMaps);
    document.getElementById('startOption').addEventListener('change', e => document.getElementById('startAddress').style.display = e.target.value === "manual" ? "block" : "none");
    cargarClientes(); cargarRutas();
});
</script>
</body>
</html>
